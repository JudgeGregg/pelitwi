<!DOCTYPE html>
<html lang="en">
<head>
          <title>Test Pelican - The Evolution of Finger: adding features to the finger service</title>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />

        <meta name="Description" content="An event-driven networking engine written in Python and MIT licensed." />

        <link rel="stylesheet" type="text/css" href="https://judgegregg.github.io/pelitwi/theme/css/twistedtrac.css" />


</head>

<body>
        <div id="banner">
                <div id="top_grad"></div>
                <div id="tab">
                        <a href="https://twistedmatrix.com/trac/wiki">HOME</a>
                        <a href="https://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions">FAQ</a>
                        <a href="/">DOCS</a>
                        <a href="https://twistedmatrix.com/trac/wiki/Downloads">DOWNLOAD</a>
                </div>

                <div id="header">
                        <a id="logo" href="https://judgegregg.github.io/pelitwi/"><img src="https://judgegregg.github.io/pelitwi/theme/images/trac_banner.png" alt="Twisted" /></a>
                </div>
        </div>

<div id="mainnav" class="related">
	<ul>
		<li><a href="https://judgegregg.github.io/pelitwi">Twisted 21.2.0 documentation</a> »</li>
	</ul>
</div>
        <div id="ctxtnav" class="nav">
        </div>

    <section>

    <div class="document">
        <div class="documentwrapper">
        <div class="bodywrapper">
        <h1>The Evolution of Finger: adding features to the finger service</h1>
        
        <div class="entry-content">
        <div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">Introduction</a></h2>
<p>This is the second part of the Twisted tutorial <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/twisted-from-scratch-or-the-evolution-of-finger.html">Twisted from Scratch, or The Evolution of Finger</a> .</p>
<p>In this section of the tutorial, our finger server will continue to sprout
features: the ability for users to set finger announces, and using our finger
service to send those announcements on the web, on IRC and over XML-RPC.
Resources and XML-RPC are introduced in the Web Applications portion of
the <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/developer-guides-web.html">Twisted Web howto</a> . More examples
using <cite>twisted.words.protocols.irc</cite> can be found
in <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/writing-clients.html">Writing a TCP Client</a> and
the <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/examples-words.html">Twisted Words examples</a> .</p>
</div>
<div class="section" id="setting-message-by-local-users">
<h2><a class="toc-backref" href="#id2">Setting Message By Local Users</a></h2>
<p>Now that port 1079 is free, maybe we can use it with a different
server, one which will let people set their messages. It does
no access control, so anyone who can login to the machine can
set any message. We assume this is the desired behavior in
our case. Testing it can be done by simply:</p>
<div class="highlight"><pre><span></span><span class="gp">% </span>nc localhost <span class="m">1079</span>   <span class="c1"># or telnet localhost 1079</span>
<span class="go">moshez</span>
<span class="go">Giving a tutorial now, sorry!</span>
<span class="go">^D</span>
</pre></div>
<p><cite>finger12.tac &lt;listings/finger/finger12.tac&gt;</cite></p>
<p>This program has two protocol-factory-TCPServer pairs, which are
both child services of the application.  Specifically,
the <cite>setServiceParent &lt;twisted.application.service.Service.setServiceParent&gt;</cite>
method is used to define the two TCPServer services as children
of <tt class="docutils literal">application</tt> , which implements <cite>IServiceCollection &lt;twisted.application.service.IServiceCollection&gt;</cite> .  Both
services are thus started with the application.</p>
</div>
<div class="section" id="use-services-to-make-dependencies-sane">
<h2><a class="toc-backref" href="#id3">Use Services to Make Dependencies Sane</a></h2>
<p>The previous version had the setter poke at the innards of the
finger factory. This strategy is usually not a good idea: this version makes
both factories symmetric by making them both look at a single
object. Services are useful for when an object is needed which is
not related to a specific network server. Here, we define a common service
class with methods that will create factories on the fly. The service
also contains methods the factories will depend on.</p>
<p>The factory-creation methods, <tt class="docutils literal">getFingerFactory</tt>
and <tt class="docutils literal">getFingerSetterFactory</tt> , follow this pattern:</p>
<ol class="arabic simple">
<li>Instantiate a generic server
factory, <tt class="docutils literal">twisted.internet.protocol.ServerFactory</tt> .</li>
<li>Set the protocol class, just like our factory class would have.</li>
<li>Copy a service method to the factory as a function attribute.  The
function won't have access to the factory's <tt class="docutils literal">self</tt> , but
that's OK because as a bound method it has access to the
service's <tt class="docutils literal">self</tt> , which is what it needs.
For <tt class="docutils literal">getUser</tt> , a custom method defined in the service gets
copied.  For <tt class="docutils literal">setUser</tt> , a standard method of
the <tt class="docutils literal">users</tt> dictionary is copied.</li>
</ol>
<p>Thus, we stopped subclassing: the service simply puts useful methods and
attributes inside the factories. We are getting better at protocol design:
none of our protocol classes had to be changed, and neither will have to
change until the end of the tutorial.</p>
<p>As an application service, this new finger service implements the <cite>IService &lt;twisted.application.service.IService&gt;</cite> interface and
can be started and stopped in a standardized manner. We'll make use of this in
the next example.</p>
<p><cite>finger13.tac &lt;listings/finger/finger13.tac&gt;</cite></p>
<p>Most application services will want to use the <cite>Service &lt;twisted.application.service.Service&gt;</cite> base class, which implements
all the generic <tt class="docutils literal">IService</tt> behavior.</p>
</div>
<div class="section" id="read-status-file">
<h2><a class="toc-backref" href="#id4">Read Status File</a></h2>
<p>This version shows how, instead of just letting users set their
messages, we can read those from a centrally managed file. We cache
results, and every 30 seconds we refresh it. Services are useful
for such scheduled tasks.</p>
<p>listings/finger/etc.users</p>
<p><cite>finger14.tac &lt;listings/finger/finger14.tac&gt;</cite></p>
<p>Since this version is reading data from a file (and refreshing the data
every 30 seconds), there is no <tt class="docutils literal">FingerSetterFactory</tt> and thus
nothing listening on port 1079.</p>
<p>Here we override the standard <cite>startService &lt;twisted.application.service.Service.startService&gt;</cite>
and <cite>stopService &lt;twisted.application.service.Service.stopService&gt;</cite> hooks in
the Finger service, which is set up as a child service of the
application in the last line of the code. <tt class="docutils literal">startService</tt>
calls <tt class="docutils literal">_read</tt> , the function responsible for reading the
data; <tt class="docutils literal">reactor.callLater</tt> is then used to schedule it to
run again after thirty seconds every time it is
called. <tt class="docutils literal">reactor.callLater</tt> returns an object that lets us
cancel the scheduled run in <tt class="docutils literal">stopService</tt> using
its <tt class="docutils literal">cancel</tt> method.</p>
</div>
<div class="section" id="announce-on-web-too">
<h2><a class="toc-backref" href="#id5">Announce on Web, Too</a></h2>
<p>The same kind of service can also produce things useful for other
protocols. For example, in twisted.web, the factory itself
(<tt class="docutils literal">Site</tt> ) is almost
never subclassed — instead, it is given a resource, which
represents the tree of resources available via URLs. That hierarchy is
navigated by <tt class="docutils literal">Site</tt>
and overriding it dynamically is possible with <tt class="docutils literal">getChild</tt> .</p>
<p>To integrate this into the Finger application (just because we can), we set
up a new TCPServer that calls the <tt class="docutils literal">Site</tt> factory and retrieves resources via a
new function of <tt class="docutils literal">FingerService</tt> named <tt class="docutils literal">getResource</tt> .
This function specifically returns a <tt class="docutils literal">Resource</tt> object with an overridden <tt class="docutils literal">getChild</tt> method.</p>
<p><cite>finger15.tac &lt;listings/finger/finger15.tac&gt;</cite></p>
</div>
<div class="section" id="announce-on-irc-too">
<h2><a class="toc-backref" href="#id6">Announce on IRC, Too</a></h2>
<p>This is the first time there is client code. IRC clients often act a lot like
servers: responding to events from the network.  The Client Service will make
sure that severed links will get re-established, with intelligent
tweaked exponential back-off algorithms. The IRC client itself is simple: the
only real hack is getting the nickname from the factory
in <tt class="docutils literal">connectionMade</tt> .</p>
<p><cite>finger16.tac &lt;listings/finger/finger16.tac&gt;</cite></p>
<p><tt class="docutils literal">FingerService</tt> now has another new
function, <tt class="docutils literal">getIRCbot</tt> , which returns
a <tt class="docutils literal">ClientFactory</tt> .  This factory in turn will
instantiate the <tt class="docutils literal">IRCReplyBot</tt> protocol.  The IRCBot is
configured in the last line to connect
to <tt class="docutils literal">irc.freenode.org</tt> with a nickname
of <tt class="docutils literal">fingerbot</tt> .</p>
<p>By
overriding <tt class="docutils literal">irc.IRCClient.connectionMade</tt> , <tt class="docutils literal">IRCReplyBot</tt>
can access the <tt class="docutils literal">nickname</tt> attribute of the factory that
instantiated it.</p>
</div>
<div class="section" id="add-xml-rpc-support">
<h2><a class="toc-backref" href="#id7">Add XML-RPC Support</a></h2>
<p>In Twisted, XML-RPC support is handled just as though it was
another resource. That resource will still support GET calls normally
through render(), but that is usually left unimplemented. Note
that it is possible to return deferreds from XML-RPC methods.
The client, of course, will not get the answer until the deferred
is triggered.</p>
<p><cite>finger17.tac &lt;listings/finger/finger17.tac&gt;</cite></p>
<p>Instead of a web browser, we can test the XMLRPC finger using a simple
client based on Python's built-in <tt class="docutils literal">xmlrpclib</tt> , which will access
the resource we've made available at <tt class="docutils literal">localhost/RPC2</tt> .</p>
<p><cite>fingerXRclient.py &lt;listings/finger/fingerXRclient.py&gt;</cite></p>

</div>

        </div>
        </div>
        </div>
<div class="sphinxsidebar">
<div class="sphinxsidebarwrapper">
<div class="toc" id="">
<p class="topic-title">Table Of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a></li>
<li><a class="reference internal" href="#setting-message-by-local-users" id="id2">Setting Message By Local Users</a></li>
<li><a class="reference internal" href="#use-services-to-make-dependencies-sane" id="id3">Use Services to Make Dependencies Sane</a></li>
<li><a class="reference internal" href="#read-status-file" id="id4">Read Status File</a></li>
<li><a class="reference internal" href="#announce-on-web-too" id="id5">Announce on Web, Too</a></li>
<li><a class="reference internal" href="#announce-on-irc-too" id="id6">Announce on IRC, Too</a></li>
<li><a class="reference internal" href="#add-xml-rpc-support" id="id7">Add XML-RPC Support</a></li>
</ul>
</div>
</div>
</div>    </div>

    </section>

        <div id="footer"><hr>
                <div> </div>
                <p class="left2">
        Copyright 2021, Twisted Matrix Labs. Ver 21.2.0. Built on 2021-02-28.<br />
        Site design<br />
        By <a href="http://huw.ugbox.net/">huw.wilkins.</a>

                </p>
                <p class="right"></p>
        </div>


</body>
</html>