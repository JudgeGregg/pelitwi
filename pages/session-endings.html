<!DOCTYPE html>
<html lang="en">
<head>
          <title>Test Pelican - Session Endings</title>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />

        <meta name="Description" content="An event-driven networking engine written in Python and MIT licensed." />

        <link rel="stylesheet" type="text/css" href="https://judgegregg.github.io/pelitwi/theme/css/twistedtrac.css" />


</head>

<body>
        <div id="banner">
                <div id="top_grad"></div>
                <div id="tab">
                        <a href="https://twistedmatrix.com/trac/wiki">HOME</a>
                        <a href="https://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions">FAQ</a>
                        <a href="/">DOCS</a>
                        <a href="https://twistedmatrix.com/trac/wiki/Downloads">DOWNLOAD</a>
                </div>

                <div id="header">
                        <a id="logo" href="https://judgegregg.github.io/pelitwi/"><img src="https://judgegregg.github.io/pelitwi/theme/images/trac_banner.png" alt="Twisted" /></a>
                </div>
        </div>

<div id="mainnav" class="related">
	<ul>
		<li><a href="https://judgegregg.github.io/pelitwi">Twisted 21.2.0 documentation</a> Â»</li>
	</ul>
</div>
        <div id="ctxtnav" class="nav">
        </div>

    <section>

    <div class="document">
        <div class="documentwrapper">
        <div class="bodywrapper">
        <h1>Session Endings</h1>
        
        <div class="entry-content">
        <p>The previous two examples introduced Twisted Web's session APIs. This
included accessing the session object, storing state on it, and retrieving it
later, as well as the idea that the <cite>Session &lt;twisted.web.server.Session&gt;</cite> object has a lifetime which is tied to
the notional session it represents. This example demonstrates how to exert some
control over that lifetime and react when it expires.</p>
<p>The lifetime of a session is controlled by the <tt class="docutils literal">sessionTimeout</tt>
attribute of the <tt class="docutils literal">Session</tt> class. This attribute gives the number of
seconds a session may go without being accessed before it expires. The default
is 15 minutes. In this example we'll change that to a different value.</p>
<p>One way to override the value is with a subclass:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.web.server</span> <span class="kn">import</span> <span class="n">Session</span>

<span class="k">class</span> <span class="nc">ShortSession</span><span class="p">(</span><span class="n">Session</span><span class="p">):</span>
    <span class="n">sessionTimeout</span> <span class="o">=</span> <span class="mi">60</span>
</pre></div>
<p>To have Twisted Web actually make use of this session class, rather
than the default, it is also necessary to override
the <tt class="docutils literal">sessionFactory</tt> attribute of <cite>Site &lt;twisted.web.server.Site&gt;</cite> . We could do this with another
subclass, but we could also do it to just one instance
of <tt class="docutils literal">Site</tt> :</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.web.server</span> <span class="kn">import</span> <span class="n">Site</span>

<span class="n">factory</span> <span class="o">=</span> <span class="n">Site</span><span class="p">(</span><span class="n">rootResource</span><span class="p">)</span>
<span class="n">factory</span><span class="o">.</span><span class="n">sessionFactory</span> <span class="o">=</span> <span class="n">ShortSession</span>
</pre></div>
<p>Sessions given out for requests served by this <tt class="docutils literal">Site</tt> will
use <tt class="docutils literal">ShortSession</tt> and only last one minute without activity.</p>
<p>You can have arbitrary functions run when sessions expire,
too. This can be useful for cleaning up external resources associated
with the session, tracking usage statistics, and more. This
functionality is provided via <cite>Session.notifyOnExpire &lt;twisted.web.server.Session.notifyOnExpire&gt;</cite> . It accepts a
single argument: a function to call when the session expires. Here's a
trivial example which prints a message whenever a session expires:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.web.resource</span> <span class="kn">import</span> <span class="n">Resource</span>

<span class="k">class</span> <span class="nc">ExpirationLogger</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="n">sessions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">render_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">getSession</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">notifyOnExpire</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expired</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">uid</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Session&quot;</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="s2">&quot;has expired.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
</pre></div>
<p>Keep in mind that using a method as the callback will keep the instance (in
this case, the <tt class="docutils literal">ExpirationLogger</tt> resource) in memory until the
session expires.</p>
<p>With those pieces in hand, here's an example that prints a message whenever a
session expires, and uses sessions which last for 5 seconds:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.web.server</span> <span class="kn">import</span> <span class="n">Site</span><span class="p">,</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">twisted.web.resource</span> <span class="kn">import</span> <span class="n">Resource</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">endpoints</span>

<span class="k">class</span> <span class="nc">ShortSession</span><span class="p">(</span><span class="n">Session</span><span class="p">):</span>
    <span class="n">sessionTimeout</span> <span class="o">=</span> <span class="mi">5</span>

<span class="k">class</span> <span class="nc">ExpirationLogger</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="n">sessions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">render_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">getSession</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">notifyOnExpire</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expired</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">uid</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Session&quot;</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="s2">&quot;has expired.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>

<span class="n">rootResource</span> <span class="o">=</span> <span class="n">Resource</span><span class="p">()</span>
<span class="n">rootResource</span><span class="o">.</span><span class="n">putChild</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;logme&quot;</span><span class="p">,</span> <span class="n">ExpirationLogger</span><span class="p">())</span>
<span class="n">factory</span> <span class="o">=</span> <span class="n">Site</span><span class="p">(</span><span class="n">rootResource</span><span class="p">)</span>
<span class="n">factory</span><span class="o">.</span><span class="n">sessionFactory</span> <span class="o">=</span> <span class="n">ShortSession</span>

<span class="n">endpoint</span> <span class="o">=</span> <span class="n">endpoints</span><span class="o">.</span><span class="n">TCP4ServerEndpoint</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="mi">8080</span><span class="p">)</span>
<span class="n">endpoint</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">factory</span><span class="p">)</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
<p>Since <tt class="docutils literal">Site</tt> customization is required, this example can't be
rpy-based, so it brings back the manual <tt class="docutils literal">endpoints.TCP4ServerEndpoint</tt>
and <tt class="docutils literal">reactor.run</tt> calls. Run it and visit <tt class="docutils literal">/logme</tt> to see
it in action. Keep visiting it to keep your session active. Stop visiting it for
five seconds to see your session expiration message.</p>

        </div>
        </div>
        </div>
<div class="sphinxsidebar">
<div class="sphinxsidebarwrapper">
</div>
</div>    </div>

    </section>

        <div id="footer"><hr>
                <div> </div>
                <p class="left2">
        Copyright 2021, Twisted Matrix Labs. Ver 21.2.0. Built on 2021-02-28.<br />
        Site design<br />
        By <a href="http://huw.ugbox.net/">huw.wilkins.</a>

                </p>
                <p class="right"></p>
        </div>


</body>
</html>