<!DOCTYPE html>
<html lang="en">
<head>
          <title>Test Pelican - twisted.enterprise.adbapi: Twisted RDBMS support</title>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />

        <meta name="Description" content="An event-driven networking engine written in Python and MIT licensed." />

        <link rel="stylesheet" type="text/css" href="https://judgegregg.github.io/pelitwi/theme/css/twistedtrac.css" />


</head>

<body>
        <div id="banner">
                <div id="top_grad"></div>
                <div id="tab">
                        <a href="https://twistedmatrix.com/trac/wiki">HOME</a>
                        <a href="https://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions">FAQ</a>
                        <a href="/">DOCS</a>
                        <a href="https://twistedmatrix.com/trac/wiki/Downloads">DOWNLOAD</a>
                </div>

                <div id="header">
                        <a id="logo" href="https://judgegregg.github.io/pelitwi/"><img src="https://judgegregg.github.io/pelitwi/theme/images/trac_banner.png" alt="Twisted" /></a>
                </div>
        </div>

<div id="mainnav" class="related">
	<ul>
		<li><a href="https://judgegregg.github.io/pelitwi">Twisted 21.2.0 documentation</a> Â»</li>
	</ul>
</div>
        <div id="ctxtnav" class="nav">
        </div>

    <section>

    <div class="document">
        <div class="documentwrapper">
        <div class="bodywrapper">
        <h1>twisted.enterprise.adbapi: Twisted RDBMS support</h1>
        
        <div class="entry-content">
        <div class="section" id="abstract">
<h2><a class="toc-backref" href="#id1">Abstract</a></h2>
<p>Twisted is an asynchronous networking framework, but most database API implementations unfortunately have blocking interfaces -- for this reason, <cite>twisted.enterprise.adbapi</cite> was created.
It is a non-blocking interface to the standardized DB-API 2.0 API, which allows you to access a number of different RDBMSes.</p>
</div>
<div class="section" id="what-you-should-already-know">
<h2><a class="toc-backref" href="#id2">What you should already know</a></h2>
<ul class="simple">
<li>Python :-)</li>
<li>How to write a simple Twisted Server (see <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/writing-servers.html">this tutorial</a> to learn how)</li>
<li>Familiarity with using database interfaces (see <a class="reference external" href="http://www.python.org/dev/peps/pep-0249/">the documentation for DBAPI 2.0</a>)</li>
</ul>
</div>
<div class="section" id="quick-overview">
<h2><a class="toc-backref" href="#id3">Quick Overview</a></h2>
<p>Twisted is an asynchronous framework.
This means standard database modules cannot be used directly, as they typically work something like:</p>
<pre class="literal-block">
# Create connection...
db = dbmodule.connect('mydb', 'andrew', 'password')
# ...which blocks for an unknown amount of time

# Create a cursor
cursor = db.cursor()

# Do a query...
resultset = cursor.query('SELECT * FROM table WHERE ...')
# ...which could take a long time, perhaps even minutes.
</pre>
<p>Those delays are unacceptable when using an asynchronous framework such as Twisted.
For this reason, Twisted provides <cite>twisted.enterprise.adbapi</cite>, an asynchronous wrapper for any <a class="reference external" href="http://www.python.org/dev/peps/pep-0249/">DB-API 2.0</a>-compliant module.</p>
<p><cite>adbapi &lt;twisted.enterprise.adbapi&gt;</cite> will do blocking database operations in separate threads, which trigger callbacks in the originating thread when they complete.
In the meantime, the original thread can continue doing normal work, like servicing other requests.</p>
</div>
<div class="section" id="how-do-i-use-adbapi">
<h2><a class="toc-backref" href="#id4">How do I use adbapi?</a></h2>
<p>Rather than creating a database connection directly, use the <cite>adbapi.ConnectionPool &lt;twisted.enterprise.adbapi.ConnectionPool&gt;</cite> class to manage a connections for you.
This allows <cite>adbapi &lt;twisted.enterprise.adbapi&gt;</cite> to use multiple connections, one per thread. This is easy:</p>
<pre class="literal-block">
# Using the "dbmodule" from the previous example, create a ConnectionPool
from twisted.enterprise import adbapi
dbpool = adbapi.ConnectionPool("dbmodule", 'mydb', 'andrew', 'password')
</pre>
<p>Things to note about doing this:</p>
<ul class="simple">
<li>There is no need to import dbmodule directly.
You just pass the name to <cite>adbapi.ConnectionPool &lt;twisted.enterprise.adbapi.ConnectionPool&gt;</cite>'s constructor.</li>
<li>The parameters you would pass to dbmodule.connect are passed as extra arguments to <cite>adbapi.ConnectionPool &lt;twisted.enterprise.adbapi.ConnectionPool&gt;</cite>'s constructor.
Keyword parameters work as well.</li>
</ul>
<p>Now we can do a database query:</p>
<pre class="literal-block">
# equivalent of cursor.execute(statement), return cursor.fetchall():
def getAge(user):
    return dbpool.runQuery("SELECT age FROM users WHERE name = ?", user)

def printResult(l):
    if l:
        print(l[0][0], "years old")
    else:
        print("No such user")

getAge("joe").addCallback(printResult)
</pre>
<p>This is straightforward, except perhaps for the return value of <tt class="docutils literal">getAge</tt>.
It returns a <cite>Deferred &lt;twisted.internet.defer.Deferred&gt;</cite>, which allows arbitrary callbacks to be called upon completion (or upon failure).
More documentation on Deferred is available <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/deferred-reference.html">here</a>.</p>
<p>In addition to <tt class="docutils literal">runQuery</tt>, there is also <tt class="docutils literal">runOperation</tt> and <tt class="docutils literal">runInteraction</tt> that gets called with a callable (e.g. a function).
The function will be called in the thread with a <cite>adbapi.Transaction &lt;twisted.enterprise.adbapi.Transaction&gt;</cite>, which basically mimics a DB-API cursor.
In all cases a database transaction will be committed after your database usage is finished, unless an exception is raised in which case it will be rolled back.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_getAge</span><span class="p">(</span><span class="n">txn</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
    <span class="c1"># this will run in a thread, we can use blocking calls</span>
    <span class="n">txn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"SELECT * FROM foo"</span><span class="p">)</span>
    <span class="c1"># ... other cursor commands called on txn ...</span>
    <span class="n">txn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"SELECT age FROM users WHERE name = ?"</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">txn</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">getAge</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">dbpool</span><span class="o">.</span><span class="n">runInteraction</span><span class="p">(</span><span class="n">_getAge</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">printResult</span><span class="p">(</span><span class="n">age</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">age</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="s2">"years old"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"No such user"</span><span class="p">)</span>

<span class="n">getAge</span><span class="p">(</span><span class="s2">"joe"</span><span class="p">)</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">printResult</span><span class="p">)</span>
</pre></div>
<p>Also worth noting is that these examples assumes that dbmodule uses the "qmarks" paramstyle (see the DB-API specification).
If your dbmodule uses a different paramstyle (e.g. pyformat) then use that.
Twisted doesn't attempt to offer any sort of magic parameter munging -- <tt class="docutils literal">runQuery(query, params, <span class="pre">...)</span></tt> maps directly onto <tt class="docutils literal">cursor.execute(query, params, <span class="pre">...)</span></tt>.</p>
</div>
<div class="section" id="examples-of-various-database-adapters">
<h2><a class="toc-backref" href="#id5">Examples of various database adapters</a></h2>
<p>Notice that the first argument is the module name you would usually import and get <tt class="docutils literal"><span class="pre">connect(...)</span></tt> from, and that following arguments are whatever arguments you'd call <tt class="docutils literal"><span class="pre">connect(...)</span></tt> with.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.enterprise</span> <span class="kn">import</span> <span class="n">adbapi</span>

<span class="c1"># PostgreSQL PyPgSQL</span>
<span class="n">cp</span> <span class="o">=</span> <span class="n">adbapi</span><span class="o">.</span><span class="n">ConnectionPool</span><span class="p">(</span><span class="s2">"pyPgSQL.PgSQL"</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="s2">"test"</span><span class="p">)</span>

<span class="c1"># MySQL</span>
<span class="n">cp</span> <span class="o">=</span> <span class="n">adbapi</span><span class="o">.</span><span class="n">ConnectionPool</span><span class="p">(</span><span class="s2">"MySQLdb"</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s2">"test"</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="and-that-s-it">
<h2><a class="toc-backref" href="#id6">And that's it!</a></h2>
<p>That's all you need to know to use a database from within Twisted.
You probably should read the adbapi module's documentation to get an idea of the other functions it has, but hopefully this document presents the core ideas.</p>

</div>

        </div>
        </div>
        </div>
<div class="sphinxsidebar">
<div class="sphinxsidebarwrapper">
<div class="toc" id="">
<p class="topic-title">Table Of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#abstract" id="id1">Abstract</a></li>
<li><a class="reference internal" href="#what-you-should-already-know" id="id2">What you should already know</a></li>
<li><a class="reference internal" href="#quick-overview" id="id3">Quick Overview</a></li>
<li><a class="reference internal" href="#how-do-i-use-adbapi" id="id4">How do I use adbapi?</a></li>
<li><a class="reference internal" href="#examples-of-various-database-adapters" id="id5">Examples of various database adapters</a></li>
<li><a class="reference internal" href="#and-that-s-it" id="id6">And that's it!</a></li>
</ul>
</div>
</div>
</div>    </div>

    </section>

        <div id="footer"><hr>
                <div> </div>
                <p class="left2">
        Copyright 2021, Twisted Matrix Labs. Ver 21.2.0. Built on 2021-02-28.<br />
        Site design<br />
        By <a href="http://huw.ugbox.net/">huw.wilkins.</a>

                </p>
                <p class="right"></p>
        </div>


</body>
</html>