<!DOCTYPE html>
<html lang="en">
<head>
          <title>Test Pelican - Writing a twistd Plugin</title>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />

        <meta name="Description" content="An event-driven networking engine written in Python and MIT licensed." />

        <link rel="stylesheet" type="text/css" href="https://judgegregg.github.io/pelitwi/theme/css/twistedtrac.css" />


</head>

<body>
        <div id="banner">
                <div id="top_grad"></div>
                <div id="tab">
                        <a href="https://twistedmatrix.com/trac/wiki">HOME</a>
                        <a href="https://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions">FAQ</a>
                        <a href="/">DOCS</a>
                        <a href="https://twistedmatrix.com/trac/wiki/Downloads">DOWNLOAD</a>
                </div>

                <div id="header">
                        <a id="logo" href="https://judgegregg.github.io/pelitwi/"><img src="https://judgegregg.github.io/pelitwi/theme/images/trac_banner.png" alt="Twisted" /></a>
                </div>
        </div>

<div id="mainnav" class="related">
	<ul>
		<li><a href="https://judgegregg.github.io/pelitwi">Twisted 21.2.0 documentation</a> Â»</li>
	</ul>
</div>
        <div id="ctxtnav" class="nav">
        </div>

    <section>

    <div class="document">
        <div class="documentwrapper">
        <div class="bodywrapper">
        <h1>Writing a twistd Plugin</h1>
        
        <div class="entry-content">
        <p>This document describes adding subcommands to the <tt class="docutils literal">twistd</tt> command,
as a way to facilitate the deployment of your applications.</p>
<p>The target audience of this document are those that have developed a Twisted application which needs a command line-based deployment mechanism.</p>
<p>There are a few prerequisites to understanding this document:</p>
<ul class="simple">
<li>A basic understanding of the Twisted Plugin System (i.e., the <cite>twisted.plugin</cite> module) is necessary,
however, step-by-step instructions will be given.
Reading <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/the-twisted-plugin-system.html">The Twisted Plugin System</a> is recommended,
in particular the "Extending an Existing Program" section.</li>
<li>The <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/using-the-twisted-application-framework.html">Application</a> infrastructure is used in <tt class="docutils literal">twistd</tt> plugins;
in particular, you should know how to expose your program's functionality as a Service.</li>
<li>In order to parse command line arguments, the <tt class="docutils literal">twistd</tt> plugin mechanism relies on <tt class="docutils literal">twisted.python.usage</tt> ,
which is documented in <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/parsing-command-lines-with-usageoptions.html">Using usage.Options</a> .</li>
</ul>
<div class="section" id="goals">
<h2><a class="toc-backref" href="#id1">Goals</a></h2>
<p>After reading this document,
the reader should be able to expose their Service-using application as a subcommand of <tt class="docutils literal">twistd</tt> ,
taking into consideration whatever was passed on the command line.</p>
</div>
<div class="section" id="alternatives-to-twistd-plugins">
<h2><a class="toc-backref" href="#id2">Alternatives to twistd Plugins</a></h2>
<p>The major alternative to the twistd plugin mechanism is the <tt class="docutils literal">.tac</tt> file,
which is a simple script to be used with the twistd <tt class="docutils literal"><span class="pre">-y/--python</span></tt> parameter.
The twistd plugin mechanism exists to offer a more extensible command-line-driven interface to your application.
For more information on <tt class="docutils literal">.tac</tt> files,
see the document <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/using-the-twisted-application-framework.html">Using the Twisted Application Framework</a> .</p>
</div>
<div class="section" id="creating-the-plugin">
<h2><a class="toc-backref" href="#id3">Creating the Plugin</a></h2>
<p>The following directory structure is assumed of your project:</p>
<ul class="simple">
<li><tt class="docutils literal">MyProject</tt> - Top level directory<ul>
<li><tt class="docutils literal">myproject</tt> - Python package<ul>
<li><tt class="docutils literal">__init__.py</tt></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>During development of your project,
Twisted plugins can be loaded from a special directory in your project,
assuming your top level directory ends up in <cite>sys.path</cite>.
Create a directory named <tt class="docutils literal">twisted</tt> containing a directory named <tt class="docutils literal">plugins</tt> ,
and add a file named <tt class="docutils literal">myproject_plugin.py</tt> to it.
This file will contain your plugin.
Note that you must <em>not</em> add any <tt class="docutils literal">__init__.py</tt> files to this directory structure,
and the plugin file should <em>not</em> be named <tt class="docutils literal">myproject.py</tt>
(because that would conflict with your project's module name).</p>
<p>In this file, define an object which <em>provides</em> the interfaces <cite>twisted.plugin.IPlugin</cite>
and <cite>twisted.application.service.IServiceMaker</cite> .</p>
<p>The <tt class="docutils literal">tapname</tt> attribute of your IServiceMaker provider will be used as the subcommand name in a command like <tt class="docutils literal">twistd [subcommand] <span class="pre">[args...]</span></tt> ,
and the <tt class="docutils literal">options</tt> attribute
(which should be a <cite>usage.Options &lt;twisted.python.usage.Options&gt;</cite> subclass)
will be used to parse the given args.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">zope.interface</span> <span class="kn">import</span> <span class="n">implementer</span>

<span class="kn">from</span> <span class="nn">twisted.python</span> <span class="kn">import</span> <span class="n">usage</span>
<span class="kn">from</span> <span class="nn">twisted.plugin</span> <span class="kn">import</span> <span class="n">IPlugin</span>
<span class="kn">from</span> <span class="nn">twisted.application.service</span> <span class="kn">import</span> <span class="n">IServiceMaker</span>
<span class="kn">from</span> <span class="nn">twisted.application</span> <span class="kn">import</span> <span class="n">internet</span>

<span class="kn">from</span> <span class="nn">myproject</span> <span class="kn">import</span> <span class="n">MyFactory</span>


<span class="k">class</span> <span class="nc">Options</span><span class="p">(</span><span class="n">usage</span><span class="o">.</span><span class="n">Options</span><span class="p">):</span>
    <span class="n">optParameters</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">"port"</span><span class="p">,</span> <span class="s2">"p"</span><span class="p">,</span> <span class="mi">1235</span><span class="p">,</span> <span class="s2">"The port number to listen on."</span><span class="p">]]</span>


<span class="nd">@implementer</span><span class="p">(</span><span class="n">IServiceMaker</span><span class="p">,</span> <span class="n">IPlugin</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyServiceMaker</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">tapname</span> <span class="o">=</span> <span class="s2">"myproject"</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">"Run this! It'll make your dog happy."</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">Options</span>

    <span class="k">def</span> <span class="nf">makeService</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Construct a TCPServer from a factory defined in myproject.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">internet</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">"port"</span><span class="p">]),</span> <span class="n">MyFactory</span><span class="p">())</span>


<span class="c1"># Now construct an object which *provides* the relevant interfaces</span>
<span class="c1"># The name of this variable is irrelevant, as long as there is *some*</span>
<span class="c1"># name bound to a provider of IPlugin and IServiceMaker.</span>
<span class="n">serviceMaker</span> <span class="o">=</span> <span class="n">MyServiceMaker</span><span class="p">()</span>
</pre></div>
<p>Now running <tt class="docutils literal">twistd <span class="pre">--help</span></tt> should print <tt class="docutils literal">myproject</tt> in the list of available subcommands,
followed by the description that we specified in the plugin.
<tt class="docutils literal">twistd <span class="pre">-n</span> myproject</tt> would,
assuming we defined a <tt class="docutils literal">MyFactory</tt> factory inside <tt class="docutils literal">myproject</tt> ,
start a listening server on port 1235 with that factory.</p>
</div>
<div class="section" id="using-cred-with-your-tap">
<h2><a class="toc-backref" href="#id4">Using <tt class="docutils literal">cred</tt> with your TAP</a></h2>
<p>Twisted ships with a robust authentication framework to use with your application.
If your server needs authentication functionality,
and you haven't read about <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/cred-pluggable-authentication.html">twisted.cred</a> yet,
read up on it first.</p>
<p>If you are building a twistd plugin and you want to support a wide variety of authentication patterns,
Twisted provides an easy-to-use mixin for your Options subclass:
<cite>strcred.AuthOptionMixin &lt;twisted.cred.strcred.AuthOptionMixin&gt;</cite> .
The following code is an example of using this mixin:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.cred</span> <span class="kn">import</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">portal</span><span class="p">,</span> <span class="n">strcred</span>
<span class="kn">from</span> <span class="nn">twisted.python</span> <span class="kn">import</span> <span class="n">usage</span>
<span class="kn">from</span> <span class="nn">twisted.plugin</span> <span class="kn">import</span> <span class="n">IPlugin</span>
<span class="kn">from</span> <span class="nn">twisted.application.service</span> <span class="kn">import</span> <span class="n">IServiceMaker</span>
<span class="kn">from</span> <span class="nn">myserver</span> <span class="kn">import</span> <span class="n">myservice</span>


<span class="k">class</span> <span class="nc">ServerOptions</span><span class="p">(</span><span class="n">usage</span><span class="o">.</span><span class="n">Options</span><span class="p">,</span> <span class="n">strcred</span><span class="o">.</span><span class="n">AuthOptionMixin</span><span class="p">):</span>
    <span class="c1"># This part is optional; it tells AuthOptionMixin what</span>
    <span class="c1"># kinds of credential interfaces the user can give us.</span>
    <span class="n">supportedInterfaces</span> <span class="o">=</span> <span class="p">(</span><span class="n">credentials</span><span class="o">.</span><span class="n">IUsernamePassword</span><span class="p">,)</span>

    <span class="n">optParameters</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s2">"port"</span><span class="p">,</span> <span class="s2">"p"</span><span class="p">,</span> <span class="mi">1234</span><span class="p">,</span> <span class="s2">"Server port number"</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">"host"</span><span class="p">,</span> <span class="s2">"h"</span><span class="p">,</span> <span class="s2">"localhost"</span><span class="p">,</span> <span class="s2">"Server hostname"</span><span class="p">]]</span>


<span class="nd">@implementer</span><span class="p">(</span><span class="n">IServiceMaker</span><span class="p">,</span> <span class="n">IPlugin</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyServerServiceMaker</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">tapname</span> <span class="o">=</span> <span class="s2">"myserver"</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">"This server does nothing productive."</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">ServerOptions</span>

    <span class="k">def</span> <span class="nf">makeService</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">"""Construct a service object."""</span>
        <span class="c1"># The realm is a custom object that your server defines.</span>
        <span class="n">realm</span> <span class="o">=</span> <span class="n">myservice</span><span class="o">.</span><span class="n">MyServerRealm</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">"host"</span><span class="p">])</span>

        <span class="c1"># The portal is something Cred can provide, as long as</span>
        <span class="c1"># you have a list of checkers that you'll support. This</span>
        <span class="c1"># list is provided my AuthOptionMixin.</span>
        <span class="n">portal</span> <span class="o">=</span> <span class="n">portal</span><span class="o">.</span><span class="n">Portal</span><span class="p">(</span><span class="n">realm</span><span class="p">,</span> <span class="n">options</span><span class="p">[</span><span class="s2">"credCheckers"</span><span class="p">])</span>

        <span class="c1"># OR, if you know you might get multiple interfaces, and</span>
        <span class="c1"># only want to give your application one of them, you</span>
        <span class="c1"># also have that option with AuthOptionMixin:</span>
        <span class="n">interface</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">IUsernamePassword</span>
        <span class="n">portal</span> <span class="o">=</span> <span class="n">portal</span><span class="o">.</span><span class="n">Portal</span><span class="p">(</span><span class="n">realm</span><span class="p">,</span> <span class="n">options</span><span class="p">[</span><span class="s2">"credInterfaces"</span><span class="p">][</span><span class="n">interface</span><span class="p">])</span>

        <span class="c1"># The protocol factory is, like the realm, something you implement.</span>
        <span class="n">factory</span> <span class="o">=</span> <span class="n">myservice</span><span class="o">.</span><span class="n">ServerFactory</span><span class="p">(</span><span class="n">realm</span><span class="p">,</span> <span class="n">portal</span><span class="p">)</span>

        <span class="c1"># Finally, return a service that will listen for connections.</span>
        <span class="k">return</span> <span class="n">internet</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">"port"</span><span class="p">]),</span> <span class="n">factory</span><span class="p">)</span>


<span class="c1"># As in our example above, we have to construct an object that</span>
<span class="c1"># provides the IPlugin and IServiceMaker interfaces.</span>
<span class="n">serviceMaker</span> <span class="o">=</span> <span class="n">MyServerServiceMaker</span><span class="p">()</span>
</pre></div>
<p>Now that you have your TAP configured to support any authentication we can throw at it,
you're ready to use it.
Here is an example of starting your server using the <tt class="docutils literal">/etc/passwd</tt> file for authentication.
(Clearly, this won't work on servers with shadow passwords.)</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>twistd myserver --auth passwd:/etc/passwd
</pre></div>
<p>For a full list of cred plugins supported,
see <cite>twisted.plugins</cite> ,
or use the command-line help:</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>twistd myserver --help-auth
<span class="gp">$ </span>twistd myserver --help-auth-type passwd
</pre></div>
</div>
<div class="section" id="deploy-your-application-using-python-packages">
<h2><a class="toc-backref" href="#id5">Deploy your Application Using Python Packages</a></h2>
<p>To deploy your application one possibility is to wrap it up in a Python package.
For this you need to write a special file <tt class="docutils literal">setup.py</tt>, which contains metadata
of the package. You would have to extend the layout of your files like this:</p>
<ul class="simple">
<li><tt class="docutils literal">MyProject</tt> - Top level directory<ul>
<li><tt class="docutils literal">setup.py</tt> - Description file for the package<ul>
<li><tt class="docutils literal">myproject</tt> - Python package<ul>
<li><tt class="docutils literal">__init__.py</tt></li>
</ul>
</li>
<li><tt class="docutils literal">twisted</tt><ul>
<li><tt class="docutils literal">plugins</tt><ul>
<li><tt class="docutils literal">myproject_plugins.py</tt> - Dropin file containing the actual plugin</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">find_packages</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">'MyApplication'</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="s1">'0.1dev'</span><span class="p">,</span>
    <span class="c1"># it is necesary to extend the found package list with the twisted.plugin</span>
    <span class="c1"># directory. It cannot be automatically detected, because it should not</span>
    <span class="c1"># contain a __init__.py file.</span>
    <span class="n">packages</span><span class="o">=</span><span class="n">find_packages</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="s1">'twisted.plugins'</span><span class="p">],</span>
    <span class="n">install_requires</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">'twisted'</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>
</pre></div>
<p>To create the Python package from the directory the standard setup tools can be used:</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>python3 setup.py sdist
</pre></div>
<p>This command creates a <tt class="docutils literal">dist</tt> directory in your project folder with the
compressed archive file <tt class="docutils literal"><span class="pre">MyApplication-0.1dev.tar.gz</span></tt>. This archive contains
all the code and additional files if specified. This file can be copied and used
for deployment.</p>
<p>To install the application just use pip. It will also install all requirements
specified in <tt class="docutils literal">setup.py</tt>.</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>pip install MyApplication-0.1dev.tar.gz
</pre></div>
<p>For more information about packaging in Python have a look at the <a class="reference external" href="https://packaging.python.org/tutorials/packaging-projects/">official
Python packaging user guide</a> or
<a class="reference external" href="https://the-hitchhikers-guide-to-packaging.readthedocs.io/">hitchhiker's guide to packaging</a>.</p>
</div>
<div class="section" id="conclusion">
<h2><a class="toc-backref" href="#id6">Conclusion</a></h2>
<p>You should now be able to</p>
<ul class="simple">
<li>Create a twistd plugin</li>
<li>Incorporate authentication into your plugin</li>
<li>Use it from your development environment</li>
<li>Install it correctly and use it in deployment</li>
</ul>

</div>

        </div>
        </div>
        </div>
<div class="sphinxsidebar">
<div class="sphinxsidebarwrapper">
<div class="toc" id="">
<p class="topic-title">Table Of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#goals" id="id1">Goals</a></li>
<li><a class="reference internal" href="#alternatives-to-twistd-plugins" id="id2">Alternatives to twistd Plugins</a></li>
<li><a class="reference internal" href="#creating-the-plugin" id="id3">Creating the Plugin</a></li>
<li><a class="reference internal" href="#using-cred-with-your-tap" id="id4">Using <tt class="docutils literal">cred</tt> with your TAP</a></li>
<li><a class="reference internal" href="#deploy-your-application-using-python-packages" id="id5">Deploy your Application Using Python Packages</a></li>
<li><a class="reference internal" href="#conclusion" id="id6">Conclusion</a></li>
</ul>
</div>
</div>
</div>    </div>

    </section>

        <div id="footer"><hr>
                <div> </div>
                <p class="left2">
        Copyright 2021, Twisted Matrix Labs. Ver 21.2.0. Built on 2021-02-28.<br />
        Site design<br />
        By <a href="http://huw.ugbox.net/">huw.wilkins.</a>

                </p>
                <p class="right"></p>
        </div>


</body>
</html>