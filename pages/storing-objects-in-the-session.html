<!DOCTYPE html>
<html lang="en">
<head>
          <title>Test Pelican - Storing Objects in the Session</title>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />

        <meta name="Description" content="An event-driven networking engine written in Python and MIT licensed." />

        <link rel="stylesheet" type="text/css" href="https://judgegregg.github.io/pelitwi/theme/css/twistedtrac.css" />


</head>

<body>
        <div id="banner">
                <div id="top_grad"></div>
                <div id="tab">
                        <a href="https://twistedmatrix.com/trac/wiki">HOME</a>
                        <a href="https://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions">FAQ</a>
                        <a href="/">DOCS</a>
                        <a href="https://twistedmatrix.com/trac/wiki/Downloads">DOWNLOAD</a>
                </div>

                <div id="header">
                        <a id="logo" href="https://judgegregg.github.io/pelitwi/"><img src="https://judgegregg.github.io/pelitwi/theme/images/trac_banner.png" alt="Twisted" /></a>
                </div>
        </div>

<div id="mainnav" class="related">
	<ul>
		<li><a href="https://judgegregg.github.io/pelitwi">Twisted 21.2.0 documentation</a> Â»</li>
	</ul>
</div>
        <div id="ctxtnav" class="nav">
        </div>

    <section>

    <div class="document">
        <div class="documentwrapper">
        <div class="bodywrapper">
        <h1>Storing Objects in the Session</h1>
        
        <div class="entry-content">
        <p>This example shows you how you can persist objects across requests in the
session object.</p>
<p>As was discussed <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/session-basics.html">previously</a> , instances
of <cite>Session &lt;twisted.web.server.Session&gt;</cite> last as long as
the notional session itself does. Each time <cite>Request.getSession &lt;twisted.web.server.Request.getSession&gt;</cite> is called, if the session
for the request is still active, then the same <tt class="docutils literal">Session</tt> instance is
returned as was returned previously. Because of this, <tt class="docutils literal">Session</tt>
instances can be used to keep other objects around for as long as the session
exists.</p>
<p>It's easier to demonstrate how this works than explain it, so here's an
example:</p>
<div class="highlight"><pre><span></span><span class="go">&gt;&gt;&gt; from zope.interface import Interface, Attribute, implementer</span>
<span class="go">&gt;&gt;&gt; from twisted.python.components import registerAdapter</span>
<span class="go">&gt;&gt;&gt; from twisted.web.server import Session</span>
<span class="go">&gt;&gt;&gt; class ICounter(Interface):</span>
<span class="go">...     value = Attribute(&quot;An int value which counts up once per page view.&quot;)</span>
<span class="go">...</span>
<span class="go">&gt;&gt;&gt; @implementer(ICounter)</span>
<span class="go">... class Counter(object):</span>
<span class="go">...     def __init__(self, session):</span>
<span class="go">...         self.value = 0</span>
<span class="go">...</span>
<span class="go">&gt;&gt;&gt; registerAdapter(Counter, Session, ICounter)</span>
<span class="go">&gt;&gt;&gt; ses = Session(None, None)</span>
<span class="go">&gt;&gt;&gt; data = ICounter(ses)</span>
<span class="go">&gt;&gt;&gt; print(data)</span>
<span class="go">&lt;__main__.Counter object at 0x8d535ec&gt;</span>
<span class="go">&gt;&gt;&gt; print(data is ICounter(ses))</span>
<span class="go">True</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
<p><em>What?</em> , I hear you say.</p>
<p>What's shown in this example is the interface and adaption-based
API which <tt class="docutils literal">Session</tt> exposes for persisting state. There are
several critical pieces interacting here:</p>
<ul class="simple">
<li><tt class="docutils literal">ICounter</tt> is an interface which serves several purposes. Like
all interfaces, it documents the API of some class of objects (in this case,
just the <tt class="docutils literal">value</tt> attribute). It also serves as a key into what is
basically a dictionary within the session object: the interface is used to
store or retrieve a value on the session (the <tt class="docutils literal">Counter</tt> instance,
in this case).</li>
<li><tt class="docutils literal">Counter</tt> is the class which actually holds the session data in
this example. It implements <tt class="docutils literal">ICounter</tt> (again, mostly for
documentation purposes). It also has a <tt class="docutils literal">value</tt> attribute, as the
interface declared.</li>
<li>The <cite>registerAdapter &lt;twisted.python.components.registerAdapter&gt;</cite> call sets up the
relationship between its three arguments so that adaption will do what we
want in this case.</li>
<li>Adaption is performed by the expression <tt class="docutils literal">ICounter(ses)</tt> . This
is read as : adapt <tt class="docutils literal">ses</tt> to <tt class="docutils literal">ICounter</tt> . Because
of the <tt class="docutils literal">registerAdapter</tt> call, it is roughly equivalent
to <tt class="docutils literal">Counter(ses)</tt> . However (because of certain
things <tt class="docutils literal">Session</tt> does), it also saves the <tt class="docutils literal">Counter</tt>
instance created so that it will be returned the next time this adaption is
done. This is why the last statement produces <tt class="docutils literal">True</tt> .</li>
</ul>
<p>If you're still not clear on some of the details there, don't worry about it
and just remember this: <tt class="docutils literal">ICounter(ses)</tt> gives you an object you can
persist state on. It can be as much or as little state as you want, and you can
use as few or as many different <tt class="docutils literal">Interface</tt> classes as you want on a
single <tt class="docutils literal">Session</tt> instance.</p>
<p>With those conceptual dependencies out of the way, it's a very short step to
actually getting persistent state into a Twisted Web application. Here's an
example which implements a simple counter, re-using the definitions from the
example above:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.web.resource</span> <span class="kn">import</span> <span class="n">Resource</span>

<span class="k">class</span> <span class="nc">CounterResource</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">render_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">getSession</span><span class="p">()</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">ICounter</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="n">counter</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset=&#39;utf-8&#39;&gt;&quot;</span>
                <span class="sa">b</span><span class="s2">&quot;&lt;title&gt;&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&quot;</span>
                <span class="sa">b</span><span class="s2">&quot;Visit #&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span>
                <span class="sa">b</span><span class="s2">&quot; for you!&quot;</span><span class="p">)</span>
</pre></div>
<p>Pretty simple from this side, eh? All this does is
use <tt class="docutils literal">Request.getSession</tt> and the adaption from above, plus some
integer math to give you a session-based visit counter.</p>
<p>Here's the complete source for an <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/rpy-scripts-or-how-to-save-yourself-some-typing.html">rpy script</a>
based on this example:</p>
<div class="highlight"><pre><span></span><span class="n">cache</span><span class="p">()</span>

<span class="kn">from</span> <span class="nn">zope.interface</span> <span class="kn">import</span> <span class="n">Interface</span><span class="p">,</span> <span class="n">Attribute</span><span class="p">,</span> <span class="n">implementer</span>
<span class="kn">from</span> <span class="nn">twisted.python.components</span> <span class="kn">import</span> <span class="n">registerAdapter</span>
<span class="kn">from</span> <span class="nn">twisted.web.server</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">twisted.web.resource</span> <span class="kn">import</span> <span class="n">Resource</span>

<span class="k">class</span> <span class="nc">ICounter</span><span class="p">(</span><span class="n">Interface</span><span class="p">):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">Attribute</span><span class="p">(</span><span class="s2">&quot;An int value which counts up once per page view.&quot;</span><span class="p">)</span>

<span class="nd">@implementer</span><span class="p">(</span><span class="n">ICounter</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Counter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">registerAdapter</span><span class="p">(</span><span class="n">Counter</span><span class="p">,</span> <span class="n">Session</span><span class="p">,</span> <span class="n">ICounter</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">CounterResource</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">render_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">getSession</span><span class="p">()</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">ICounter</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="n">counter</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset=&#39;utf-8&#39;&gt;&quot;</span>
                <span class="sa">b</span><span class="s2">&quot;&lt;title&gt;&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&quot;</span>
                <span class="sa">b</span><span class="s2">&quot;Visit #&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span>
                <span class="sa">b</span><span class="s2">&quot; for you!&quot;</span><span class="p">)</span>

<span class="n">resource</span> <span class="o">=</span> <span class="n">CounterResource</span><span class="p">()</span>
</pre></div>
<p>One more thing to note is the <tt class="docutils literal">cache()</tt> call at the top
of this example. As with the <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/http-authentication.html">previous example</a> where this came up, this rpy script is stateful. This
time, it's the <tt class="docutils literal">ICounter</tt> definition and
the <tt class="docutils literal">registerAdapter</tt> call that need to be executed only
once. If we didn't use <tt class="docutils literal">cache</tt> , every request would define
a new, different interface named <tt class="docutils literal">ICounter</tt> . Each of these
would be a different key in the session, so the counter would never
get past one.</p>

        </div>
        </div>
        </div>
<div class="sphinxsidebar">
<div class="sphinxsidebarwrapper">
</div>
</div>    </div>

    </section>

        <div id="footer"><hr>
                <div> </div>
                <p class="left2">
        Copyright 2021, Twisted Matrix Labs. Ver 21.2.0. Built on 2021-02-28.<br />
        Site design<br />
        By <a href="http://huw.ugbox.net/">huw.wilkins.</a>

                </p>
                <p class="right"></p>
        </div>


</body>
</html>