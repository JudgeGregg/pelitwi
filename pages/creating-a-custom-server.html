<!DOCTYPE html>
<html lang="en">
<head>
          <title>Test Pelican - Creating a custom server</title>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />

        <meta name="Description" content="An event-driven networking engine written in Python and MIT licensed." />

        <link rel="stylesheet" type="text/css" href="https://judgegregg.github.io/pelitwi/theme/css/twistedtrac.css" />


</head>

<body>
        <div id="banner">
                <div id="top_grad"></div>
                <div id="tab">
                        <a href="https://twistedmatrix.com/trac/wiki">HOME</a>
                        <a href="https://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions">FAQ</a>
                        <a href="/">DOCS</a>
                        <a href="https://twistedmatrix.com/trac/wiki/Downloads">DOWNLOAD</a>
                </div>

                <div id="header">
                        <a id="logo" href="https://judgegregg.github.io/pelitwi/"><img src="https://judgegregg.github.io/pelitwi/theme/images/trac_banner.png" alt="Twisted" /></a>
                </div>
        </div>

<div id="mainnav" class="related">
	<ul>
		<li><a href="https://judgegregg.github.io/pelitwi">Twisted 21.2.0 documentation</a> Â»</li>
	</ul>
</div>
        <div id="ctxtnav" class="nav">
        </div>

    <section>

    <div class="document">
        <div class="documentwrapper">
        <div class="bodywrapper">
        <h1>Creating a custom server</h1>
        
        <div class="entry-content">
        <p>The builtin DNS server plugin is useful,
but the beauty of Twisted Names is that you can build your own custom servers and clients using the names components.</p>
<blockquote>
<ul class="simple">
<li>In this section you will learn about the components required to build a simple DNS server.</li>
<li>You will then learn how to create a custom DNS server which calculates responses dynamically.</li>
</ul>
</blockquote>
<div class="section" id="a-simple-forwarding-dns-server">
<h2><a class="toc-backref" href="#id1">A simple forwarding DNS server</a></h2>
<p>Lets start by creating a simple forwarding DNS server, which forwards all requests to an upstream server (or servers).</p>
<p><cite>simple_server.py &lt;listings/names/simple_server.py&gt;</cite></p>
<p>In this example we are passing a <cite>client.Resolver &lt;twisted.names.client.Resolver&gt;</cite> instance
to the <cite>DNSServerFactory &lt;twisted.names.server.DNSServerFactory&gt;</cite>
and we are configuring that client to use the upstream DNS servers which are specified in a local <tt class="docutils literal">resolv.conf</tt> file.</p>
<p>Also note that we start the server listening on both UDP and TCP ports.
This is a standard requirement for DNS servers.</p>
<p>You can test the server using <tt class="docutils literal">dig</tt>.
For example:</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>dig -p <span class="m">10053</span> @127.0.0.1 example.com SOA +short
<span class="go">sns.dns.icann.org. noc.dns.icann.org. 2013102791 7200 3600 1209600 3600</span>
</pre></div>
</div>
<div class="section" id="a-server-which-computes-responses-dynamically">
<h2><a class="toc-backref" href="#id2">A server which computes responses dynamically</a></h2>
<p>Now suppose we want to create a bespoke DNS server which responds to certain hostname queries
by dynamically calculating the resulting IP address, while passing all other queries to another DNS server.
Queries for hostnames matching the pattern <strong>workstation{0-9}+</strong>
will result in an IP address where the last octet matches the workstation number.</p>
<p>We'll write a custom resolver which we insert before the standard client resolver.
The custom resolver will be queried first.</p>
<p>Here's the code:</p>
<p><cite>override_server.py &lt;listings/names/override_server.py&gt;</cite></p>
<p>Notice that <tt class="docutils literal">DynamicResolver.query</tt> returns a <cite>Deferred &lt;twisted.internet.defer.Deferred&gt;</cite>.
On success, it returns three lists of DNS records (answers, authority, additional),
which will be encoded by <cite>dns.Message &lt;twisted.names.dns.Message&gt;</cite> and returned to the client.
On failure, it returns a <cite>DomainError &lt;twisted.names.error.DomainError&gt;</cite>,
which is a signal that the query should be dispatched to the next client resolver in the list.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The fallback behaviour is actually handled by <cite>ResolverChain &lt;twisted.names.resolve.ResolverChain&gt;</cite>.</p>
<p>ResolverChain is a proxy for other resolvers.
It takes a list of <cite>IResolver &lt;twisted.internet.interfaces.IResolver&gt;</cite> providers
and queries each one in turn until it receives an answer, or until the list is exhausted.</p>
<p>Each <cite>IResolver &lt;twisted.internet.interfaces.IResolver&gt;</cite> in the chain may return a deferred <cite>DomainError &lt;twisted.names.error.DomainError&gt;</cite>,
which is a signal that <cite>ResolverChain &lt;twisted.names.resolve.ResolverChain&gt;</cite> should query the next chained resolver.</p>
<p class="last">The <cite>DNSServerFactory &lt;twisted.names.server.DNSServerFactory&gt;</cite> constructor takes a list of authoritative resolvers, caches and client resolvers
and ensures that they are added to the <cite>ResolverChain &lt;twisted.names.resolve.ResolverChain&gt;</cite> in the correct order.</p>
</div>
<p>Let's use <tt class="docutils literal">dig</tt> to see how this server responds to requests that match the pattern we specified:</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>dig -p <span class="m">10053</span> @127.0.0.1 workstation1.example.com A +short
<span class="go">172.0.2.1</span>

<span class="gp">$ </span>dig -p <span class="m">10053</span> @127.0.0.1 workstation100.example.com A +short
<span class="go">172.0.2.100</span>
</pre></div>
<p>And if we issue a request that doesn't match the pattern:</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>dig -p <span class="m">10053</span> @localhost www.example.com A +short
<span class="go">93.184.216.119</span>
</pre></div>
</div>
<div class="section" id="further-reading">
<h2><a class="toc-backref" href="#id3">Further Reading</a></h2>
<p>For simplicity, the examples above use the <tt class="docutils literal">reactor.listenXXX</tt> APIs.
But your application will be more flexible if you use the <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/using-the-twisted-application-framework.html">Twisted Application APIs</a>,
along with the <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/the-twisted-plugin-system.html">Twisted plugin system</a> and <tt class="docutils literal">twistd</tt>.
Read the source code of <cite>names.tap &lt;twisted.names.tap&gt;</cite> to see how the <tt class="docutils literal">twistd names</tt> plugin works.</p>

</div>

        </div>
        </div>
        </div>
<div class="sphinxsidebar">
<div class="sphinxsidebarwrapper">
<div class="toc" id="">
<p class="topic-title">Table Of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#a-simple-forwarding-dns-server" id="id1">A simple forwarding DNS server</a></li>
<li><a class="reference internal" href="#a-server-which-computes-responses-dynamically" id="id2">A server which computes responses dynamically</a></li>
<li><a class="reference internal" href="#further-reading" id="id3">Further Reading</a></li>
</ul>
</div>
</div>
</div>    </div>

    </section>

        <div id="footer"><hr>
                <div> </div>
                <p class="left2">
        Copyright 2021, Twisted Matrix Labs. Ver 21.2.0. Built on 2021-02-28.<br />
        Site design<br />
        By <a href="http://huw.ugbox.net/">huw.wilkins.</a>

                </p>
                <p class="right"></p>
        </div>


</body>
</html>