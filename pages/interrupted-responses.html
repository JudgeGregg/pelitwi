<!DOCTYPE html>
<html lang="en">
<head>
          <title>Test Pelican - Interrupted Responses</title>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />

        <meta name="Description" content="An event-driven networking engine written in Python and MIT licensed." />

        <link rel="stylesheet" type="text/css" href="https://judgegregg.github.io/pelitwi/theme/css/twistedtrac.css" />


</head>

<body>
        <div id="banner">
                <div id="top_grad"></div>
                <div id="tab">
                        <a href="https://twistedmatrix.com/trac/wiki">HOME</a>
                        <a href="https://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions">FAQ</a>
                        <a href="/">DOCS</a>
                        <a href="https://twistedmatrix.com/trac/wiki/Downloads">DOWNLOAD</a>
                </div>

                <div id="header">
                        <a id="logo" href="https://judgegregg.github.io/pelitwi/"><img src="https://judgegregg.github.io/pelitwi/theme/images/trac_banner.png" alt="Twisted" /></a>
                </div>
        </div>

<div id="mainnav" class="related">
	<ul>
		<li><a href="https://judgegregg.github.io/pelitwi">Twisted 21.2.0 documentation</a> Â»</li>
	</ul>
</div>
        <div id="ctxtnav" class="nav">
        </div>

    <section>

    <div class="document">
        <div class="documentwrapper">
        <div class="bodywrapper">
        <h1>Interrupted Responses</h1>
        
        <div class="entry-content">
        <p>The previous example had a Resource that generates its response
asynchronously rather than immediately upon the call to its render method. When
generating responses asynchronously, the possibility is introduced that the
connection to the client may be lost before the response is generated. In such a
case, it is often desirable to abandon the response generation entirely, since
there is nothing to do with the data once it is produced. This example shows how
to be notified that the connection has been lost.</p>
<p>This example will build upon the <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/asynchronous-responses.html">asynchronous responses example</a> which simply (if not very realistically) generated its
response after a fixed delay. We will expand that resource so that as soon as
the client connection is lost, the delayed event is cancelled and the response
is never generated.</p>
<p>The feature this example relies on is provided by another <cite>Request &lt;twisted.web.server.Request&gt;</cite> method: <cite>notifyFinish &lt;twisted.web.http.Request.notifyFinish&gt;</cite> . This method returns a new
Deferred which will fire with <tt class="docutils literal">None</tt> if the request is successfully
responded to or with an error otherwise - for example if the connection is lost
before the response is sent.</p>
<p>The example starts in a familiar way, with the requisite Twisted imports and
a resource class with the same <tt class="docutils literal">_delayedRender</tt> used previously:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.web.resource</span> <span class="kn">import</span> <span class="n">Resource</span>
<span class="kn">from</span> <span class="nn">twisted.web.server</span> <span class="kn">import</span> <span class="n">NOT_DONE_YET</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>

<span class="k">class</span> <span class="nc">DelayedResource</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_delayedRender</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&lt;html&gt;&lt;body&gt;Sorry to keep you waiting.&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</pre></div>
<p>Before defining the render method, we're going to define an errback
(an errback being a callback that gets called when there's an error),
though. This will be the errback attached to the <tt class="docutils literal">Deferred</tt>
returned by <tt class="docutils literal">Request.notifyFinish</tt> . It will cancel the
delayed call to <tt class="docutils literal">_delayedRender</tt> .</p>
<div class="highlight"><pre><span></span><span class="o">...</span>
    <span class="k">def</span> <span class="nf">_responseFailed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span>
        <span class="n">call</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
</pre></div>
<p>Finally, the render method will set up the delayed call just as it
did before, and return <tt class="docutils literal">NOT_DONE_YET</tt> likewise. However, it
will also use <tt class="docutils literal">Request.notifyFinish</tt> to make
sure <tt class="docutils literal">_responseFailed</tt> is called if appropriate.</p>
<div class="highlight"><pre><span></span><span class="o">...</span>
    <span class="k">def</span> <span class="nf">render_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">call</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delayedRender</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">notifyFinish</span><span class="p">()</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_responseFailed</span><span class="p">,</span> <span class="n">call</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">NOT_DONE_YET</span>
</pre></div>
<p>Notice that since <tt class="docutils literal">_responseFailed</tt> needs a reference to
the delayed call object in order to cancel it, we passed that object
to <tt class="docutils literal">addErrback</tt> . Any additional arguments passed
to <tt class="docutils literal">addErrback</tt> (or <tt class="docutils literal">addCallback</tt> ) will be
passed along to the errback after the <cite>Failure &lt;twisted.python.failure.Failure&gt;</cite> instance which is always
passed as the first argument. Passing <tt class="docutils literal">call</tt> here means it
will be passed to <tt class="docutils literal">_responseFailed</tt> , where it is expected
and required.</p>
<p>That covers almost all the code for this example. Here's the entire example
without interruptions, as an <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/rpy-scripts-or-how-to-save-yourself-some-typing.html">rpy script</a> :</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.web.resource</span> <span class="kn">import</span> <span class="n">Resource</span>
<span class="kn">from</span> <span class="nn">twisted.web.server</span> <span class="kn">import</span> <span class="n">NOT_DONE_YET</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>

<span class="k">class</span> <span class="nc">DelayedResource</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_delayedRender</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&lt;html&gt;&lt;body&gt;Sorry to keep you waiting.&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_responseFailed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span>
        <span class="n">call</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">render_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">call</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delayedRender</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">notifyFinish</span><span class="p">()</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_responseFailed</span><span class="p">,</span> <span class="n">call</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">NOT_DONE_YET</span>

<span class="n">resource</span> <span class="o">=</span> <span class="n">DelayedResource</span><span class="p">()</span>
</pre></div>
<p>Toss this into <tt class="docutils literal">example.rpy</tt> , fire it up with <tt class="docutils literal">twistd <span class="pre">-n</span> web <span class="pre">--path</span> .</tt> , and
hit <a class="reference external" href="http://localhost:8080/example.rpy">http://localhost:8080/example.rpy</a> . If
you wait five seconds, you'll get the page content. If you interrupt the request
before then, say by hitting escape (in Firefox, at least), then you'll see
perhaps the most boring demonstration ever - no page content, and nothing in the
server logs. Success!</p>

        </div>
        </div>
        </div>
<div class="sphinxsidebar">
<div class="sphinxsidebarwrapper">
</div>
</div>    </div>

    </section>

        <div id="footer"><hr>
                <div> </div>
                <p class="left2">
        Copyright 2021, Twisted Matrix Labs. Ver 21.2.0. Built on 2021-02-28.<br />
        Site design<br />
        By <a href="http://huw.ugbox.net/">huw.wilkins.</a>

                </p>
                <p class="right"></p>
        </div>


</body>
</html>