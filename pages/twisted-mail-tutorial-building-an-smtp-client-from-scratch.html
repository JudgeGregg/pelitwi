<!DOCTYPE html>
<html lang="en">
<head>
          <title>Test Pelican - Twisted Mail Tutorial: Building an SMTP Client from Scratch</title>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />

        <meta name="Description" content="An event-driven networking engine written in Python and MIT licensed." />

        <link rel="stylesheet" type="text/css" href="https://judgegregg.github.io/pelitwi/theme/css/twistedtrac.css" />


</head>

<body>
        <div id="banner">
                <div id="top_grad"></div>
                <div id="tab">
                        <a href="https://twistedmatrix.com/trac/wiki">HOME</a>
                        <a href="https://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions">FAQ</a>
                        <a href="/">DOCS</a>
                        <a href="https://twistedmatrix.com/trac/wiki/Downloads">DOWNLOAD</a>
                </div>

                <div id="header">
                        <a id="logo" href="https://judgegregg.github.io/pelitwi/"><img src="https://judgegregg.github.io/pelitwi/theme/images/trac_banner.png" alt="Twisted" /></a>
                </div>
        </div>

<div id="mainnav" class="related">
	<ul>
		<li><a href="https://judgegregg.github.io/pelitwi">Twisted 21.2.0 documentation</a> Â»</li>
	</ul>
</div>
        <div id="ctxtnav" class="nav">
        </div>

    <section>

    <div class="document">
        <div class="documentwrapper">
        <div class="bodywrapper">
        <h1>Twisted Mail Tutorial: Building an SMTP Client from Scratch</h1>
        
        <div class="entry-content">
        <p>This tutorial will walk you through the creation of an extremely
simple SMTP client application.  By the time the tutorial is complete,
you will understand how to create and start a TCP client speaking the
SMTP protocol, have it connect to an appropriate mail exchange server,
and transmit a message for delivery.</p>
<p>For the majority of this tutorial, <tt class="docutils literal">twistd</tt> will be used
to launch the application.  Near the end we will explore other
possibilities for starting a Twisted application.  Until then, make
sure that you have <tt class="docutils literal">twistd</tt> installed and conveniently
accessible for use in running each of the example <tt class="docutils literal">.tac</tt>
files.</p>
<div class="section" id="smtp-client-1">
<h2><a class="toc-backref" href="#id1">SMTP Client 1</a></h2>
<p>The first step is to create <cite>smtpclient-1.tac</cite> possible for use by <tt class="docutils literal">twistd</tt> .</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.application</span> <span class="kn">import</span> <span class="n">service</span>
</pre></div>
<p>The first line of the <tt class="docutils literal">.tac</tt> file
imports <tt class="docutils literal">twisted.application.service</tt> , a module which
contains many of the basic <em>service</em> classes and helper
functions available in Twisted.  In particular, we will be using
the <tt class="docutils literal">Application</tt> function to create a new <em>application service</em> .  An <em>application service</em> simply acts as a
central object on which to store certain kinds of deployment
configuration.</p>
<div class="highlight"><pre><span></span><span class="n">application</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">Application</span><span class="p">(</span><span class="s2">"SMTP Client Tutorial"</span><span class="p">)</span>
</pre></div>
<p>The second line of the <tt class="docutils literal">.tac</tt> file creates a
new <em>application service</em> and binds it to the local
name <tt class="docutils literal">application</tt> .  <tt class="docutils literal">twistd</tt> requires this
local name in each <tt class="docutils literal">.tac</tt> file it runs.  It uses various
pieces of configuration on the object to determine its behavior.  For
example, <tt class="docutils literal">"SMTP Client Tutorial"</tt> will be used as the name
of the <tt class="docutils literal">.tap</tt> file into which to serialize application
state, should it be necessary to do so.</p>
<p>That does it for the first example.  We now have enough of
a <tt class="docutils literal">.tac</tt> file to pass to <tt class="docutils literal">twistd</tt> .  If we
run <cite>smtpclient-1.tac</cite> using
the <tt class="docutils literal">twistd</tt> command line:</p>
<div class="highlight"><pre><span></span><span class="n">twistd</span> <span class="o">-</span><span class="n">ny</span> <span class="n">smtpclient</span><span class="o">-</span><span class="mf">1.</span><span class="n">tac</span>
</pre></div>
<p>we are rewarded with the following output:</p>
<div class="highlight"><pre><span></span><span class="gp">exarkun@boson:~/mail/tutorial/smtpclient$ </span>twistd -ny smtpclient-1.tac
<span class="go">18:31 EST [-] Log opened.</span>
<span class="go">18:31 EST [-] twistd 2.0.0 (/usr/bin/python2.4 2.4.1) starting up</span>
<span class="go">18:31 EST [-] reactor class: twisted.internet.selectreactor.SelectReactor</span>
<span class="go">18:31 EST [-] Loading smtpclient-1.tac...</span>
<span class="go">18:31 EST [-] Loaded.</span>
</pre></div>
<p>As we expected, not much is going on.  We can shutdown this server
by issuing <tt class="docutils literal">^C</tt> :</p>
<div class="highlight"><pre><span></span><span class="go">18:34 EST [-] Received SIGINT, shutting down.</span>
<span class="go">18:34 EST [-] Main loop terminated.</span>
<span class="go">18:34 EST [-] Server Shut Down.</span>
<span class="gp">exarkun@boson:~/mail/tutorial/smtpclient$</span>
</pre></div>
</div>
<div class="section" id="smtp-client-2">
<h2><a class="toc-backref" href="#id2">SMTP Client 2</a></h2>
<p>The first version of our SMTP client wasn't very interesting.  It
didn't even establish any TCP connections!  The <cite>smtpclient-2.tac</cite> will come a little bit
closer to that level of complexity.  First, we need to import a few
more things:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.application</span> <span class="kn">import</span> <span class="n">internet</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">protocol</span>
</pre></div>
<p><tt class="docutils literal">twisted.application.internet</tt> is
another <em>application service</em> module.  It provides services for
establishing outgoing connections (as well as creating network
servers, though we are not interested in those parts for the
moment). <tt class="docutils literal">twisted.internet.protocol</tt> provides base
implementations of many of the core Twisted concepts, such
as <em>factories</em> and <em>protocols</em> .</p>
<p>The next line of <cite>smtpclient-2.tac</cite>
instantiates a new <em>client factory</em> .</p>
<div class="highlight"><pre><span></span><span class="n">smtpClientFactory</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">ClientFactory</span><span class="p">()</span>
</pre></div>
<p><em>Client factories</em> are responsible for
constructing <em>protocol instances</em> whenever connections are
established.  They may be required to create just one instance, or
many instances if many different connections are established, or they
may never be required to create one at all, if no connection ever
manages to be established.</p>
<p>Now that we have a client factory, we'll need to hook it up to the
network somehow.  The next line of <tt class="docutils literal"><span class="pre">smtpclient-2.tac</span></tt> does
just that:</p>
<div class="highlight"><pre><span></span><span class="n">smtpClientService</span> <span class="o">=</span> <span class="n">internet</span><span class="o">.</span><span class="n">TCPClient</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">smtpClientFactory</span><span class="p">)</span>
</pre></div>
<p>We'll ignore the first two arguments
to <tt class="docutils literal">internet.TCPClient</tt> for the moment and instead focus on
the third.  <tt class="docutils literal">TCPClient</tt> is one of those <em>application service</em> classes.  It creates TCP connections to a specified
address and then uses its third argument, a <em>client factory</em> ,
to get a <em>protocol instance</em> .  It then associates the TCP
connection with the protocol instance and gets out of the way.</p>
<p>We can try to run <tt class="docutils literal"><span class="pre">smtpclient-2.tac</span></tt> the same way we
ran <tt class="docutils literal"><span class="pre">smtpclient-1.tac</span></tt> , but the results might be a little
disappointing:</p>
<div class="highlight"><pre><span></span><span class="gp">exarkun@boson:~/mail/tutorial/smtpclient$ </span>twistd -ny smtpclient-2.tac
<span class="go">18:55 EST [-] Log opened.</span>
<span class="go">18:55 EST [-] twistd SVN-Trunk (/usr/bin/python2.4 2.4.1) starting up</span>
<span class="go">18:55 EST [-] reactor class: twisted.internet.selectreactor.SelectReactor</span>
<span class="go">18:55 EST [-] Loading smtpclient-2.tac...</span>
<span class="go">18:55 EST [-] Loaded.</span>
<span class="go">18:55 EST [-] Starting factory &lt;twisted.internet.protocol.ClientFactory</span>
<span class="go">              instance at 0xb791e46c&gt;</span>
<span class="go">18:55 EST [-] Traceback (most recent call last):</span>
<span class="go">          File "twisted/scripts/twistd.py", line 187, in runApp</span>
<span class="go">            app.runReactorWithLogging(config, oldstdout, oldstderr)</span>
<span class="go">          File "twisted/application/app.py", line 128, in runReactorWithLogging</span>
<span class="go">            reactor.run()</span>
<span class="go">          File "twisted/internet/posixbase.py", line 200, in run</span>
<span class="go">            self.mainLoop()</span>
<span class="go">          File "twisted/internet/posixbase.py", line 208, in mainLoop</span>
<span class="go">            self.runUntilCurrent()</span>
<span class="go">        --- &lt;exception caught here&gt; ---</span>
<span class="go">          File "twisted/internet/base.py", line 533, in runUntilCurrent</span>
<span class="go">            call.func(*call.args, **call.kw)</span>
<span class="go">          File "twisted/internet/tcp.py", line 489, in resolveAddress</span>
<span class="go">            if abstract.isIPAddress(self.addr[0]):</span>
<span class="go">          File "twisted/internet/abstract.py", line 315, in isIPAddress</span>
<span class="go">            parts = string.split(addr, '.')</span>
<span class="go">          File "/usr/lib/python2.4/string.py", line 292, in split</span>
<span class="go">            return s.split(sep, maxsplit)</span>
<span class="go">        exceptions.AttributeError: 'NoneType' object has no attribute 'split'</span>

<span class="go">18:55 EST [-] Received SIGINT, shutting down.</span>
<span class="go">18:55 EST [-] Main loop terminated.</span>
<span class="go">18:55 EST [-] Server Shut Down.</span>
<span class="gp">exarkun@boson:~/mail/tutorial/smtpclient$</span>
</pre></div>
<p>What happened?  Those first two arguments to <tt class="docutils literal">TCPClient</tt>
turned out to be important after all.  We'll get to them in the next
example.</p>
</div>
<div class="section" id="smtp-client-3">
<h2><a class="toc-backref" href="#id3">SMTP Client 3</a></h2>
<p>Version three of our SMTP client only changes one thing.  The line
from version two:</p>
<div class="highlight"><pre><span></span><span class="n">smtpClientService</span> <span class="o">=</span> <span class="n">internet</span><span class="o">.</span><span class="n">TCPClient</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">smtpClientFactory</span><span class="p">)</span>
</pre></div>
<p>has its first two arguments changed from <tt class="docutils literal">None</tt> to
something with a bit more meaning:</p>
<div class="highlight"><pre><span></span><span class="n">smtpClientService</span> <span class="o">=</span> <span class="n">internet</span><span class="o">.</span><span class="n">TCPClient</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">smtpClientFactory</span><span class="p">)</span>
</pre></div>
<p>This directs the client to connect to <em>localhost</em> on
port <em>25</em> .  This isn't the address we want ultimately, but it's
a good place-holder for the time being.  We can
run <cite>smtpclient-3.tac</cite> and see what this
change gets us:</p>
<div class="highlight"><pre><span></span><span class="gp">exarkun@boson:~/mail/tutorial/smtpclient$ </span>twistd -ny smtpclient-3.tac
<span class="go">19:10 EST [-] Log opened.</span>
<span class="go">19:10 EST [-] twistd SVN-Trunk (/usr/bin/python2.4 2.4.1) starting up</span>
<span class="go">19:10 EST [-] reactor class: twisted.internet.selectreactor.SelectReactor</span>
<span class="go">19:10 EST [-] Loading smtpclient-3.tac...</span>
<span class="go">19:10 EST [-] Loaded.</span>
<span class="go">19:10 EST [-] Starting factory &lt;twisted.internet.protocol.ClientFactory</span>
<span class="go">              instance at 0xb791e48c&gt;</span>
<span class="go">19:10 EST [-] Enabling Multithreading.</span>
<span class="go">19:10 EST [Uninitialized] Traceback (most recent call last):</span>
<span class="go">          File "twisted/python/log.py", line 56, in callWithLogger</span>
<span class="go">            return callWithContext({"system": lp}, func, *args, **kw)</span>
<span class="go">          File "twisted/python/log.py", line 41, in callWithContext</span>
<span class="go">            return context.call({ILogContext: newCtx}, func, *args, **kw)</span>
<span class="go">          File "twisted/python/context.py", line 52, in callWithContext</span>
<span class="go">            return self.currentContext().callWithContext(ctx, func, *args, **kw)</span>
<span class="go">          File "twisted/python/context.py", line 31, in callWithContext</span>
<span class="go">            return func(*args,**kw)</span>
<span class="go">        --- &lt;exception caught here&gt; ---</span>
<span class="go">          File "twisted/internet/selectreactor.py", line 139, in _doReadOrWrite</span>
<span class="go">            why = getattr(selectable, method)()</span>
<span class="go">          File "twisted/internet/tcp.py", line 543, in doConnect</span>
<span class="go">            self._connectDone()</span>
<span class="go">          File "twisted/internet/tcp.py", line 546, in _connectDone</span>
<span class="go">            self.protocol = self.connector.buildProtocol(self.getPeer())</span>
<span class="go">          File "twisted/internet/base.py", line 641, in buildProtocol</span>
<span class="go">            return self.factory.buildProtocol(addr)</span>
<span class="go">          File "twisted/internet/protocol.py", line 99, in buildProtocol</span>
<span class="go">            p = self.protocol()</span>
<span class="go">        exceptions.TypeError: 'NoneType' object is not callable</span>

<span class="go">19:10 EST [Uninitialized] Stopping factory</span>
<span class="go">          &lt;twisted.internet.protocol.ClientFactory instance at</span>
<span class="go">          0xb791e48c&gt;</span>
<span class="go">19:10 EST [-] Received SIGINT, shutting down.</span>
<span class="go">19:10 EST [-] Main loop terminated.</span>
<span class="go">19:10 EST [-] Server Shut Down.</span>
<span class="gp">exarkun@boson:~/mail/tutorial/smtpclient$</span>
</pre></div>
<p>A meager amount of progress, but the service still raises an
exception.  This time, it's because we haven't specified
a <em>protocol class</em> for the factory to use.  We'll do that in
the next example.</p>
</div>
<div class="section" id="smtp-client-4">
<h2><a class="toc-backref" href="#id4">SMTP Client 4</a></h2>
<p>In the previous example, we ran into a problem because we hadn't
set up our <em>client factory's</em> <em>protocol</em> attribute
correctly (or at all).  <tt class="docutils literal">ClientFactory.buildProtocol</tt> is
the method responsible for creating a <em>protocol instance</em> .  The
default implementation calls the factory's <tt class="docutils literal">protocol</tt> attribute,
adds itself as an attribute named <tt class="docutils literal">factory</tt> to the
resulting instance, and returns it.  In <cite>smtpclient-4.tac</cite> , we'll correct the
oversight that caused the traceback in smtpclient-3.tac:</p>
<div class="highlight"><pre><span></span><span class="n">smtpClientFactory</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">Protocol</span>
</pre></div>
<p>Running this version of the client, we can see the output is once
again traceback free:</p>
<div class="highlight"><pre><span></span><span class="gp">exarkun@boson:~/doc/mail/tutorial/smtpclient$ </span>twistd -ny smtpclient-4.tac
<span class="go">19:29 EST [-] Log opened.</span>
<span class="go">19:29 EST [-] twistd SVN-Trunk (/usr/bin/python2.4 2.4.1) starting up</span>
<span class="go">19:29 EST [-] reactor class: twisted.internet.selectreactor.SelectReactor</span>
<span class="go">19:29 EST [-] Loading smtpclient-4.tac...</span>
<span class="go">19:29 EST [-] Loaded.</span>
<span class="go">19:29 EST [-] Starting factory &lt;twisted.internet.protocol.ClientFactory</span>
<span class="go">              instance at 0xb791e4ac&gt;</span>
<span class="go">19:29 EST [-] Enabling Multithreading.</span>
<span class="go">19:29 EST [-] Received SIGINT, shutting down.</span>
<span class="go">19:29 EST [Protocol,client] Stopping factory</span>
<span class="go">          &lt;twisted.internet.protocol.ClientFactory instance at</span>
<span class="go">          0xb791e4ac&gt;</span>
<span class="go">19:29 EST [-] Main loop terminated.</span>
<span class="go">19:29 EST [-] Server Shut Down.</span>
<span class="gp">exarkun@boson:~/doc/mail/tutorial/smtpclient$</span>
</pre></div>
<p>But what does this
mean? <tt class="docutils literal">twisted.internet.protocol.Protocol</tt> is the
base <em>protocol</em> implementation.  For those familiar with the
classic UNIX network services, it is equivalent to
the <em>discard</em> service.  It never produces any output and it
discards all its input.  Not terribly useful, and certainly nothing
like an SMTP client.  Let's see how we can improve this in the next
example.</p>
</div>
<div class="section" id="smtp-client-5">
<h2><a class="toc-backref" href="#id5">SMTP Client 5</a></h2>
<p>In <cite>smtpclient-5.tac</cite> , we will begin
to use Twisted's SMTP protocol implementation for the first time.
We'll make the obvious change, simply swapping
out <tt class="docutils literal">twisted.internet.protocol.Protocol</tt> in favor
of <tt class="docutils literal">twisted.mail.smtp.ESMTPClient</tt> .  Don't worry about
the <em>E</em> in <em>ESMTP</em> .  It indicates we're actually using a
newer version of the SMTP protocol.  There is
an <tt class="docutils literal">SMTPClient</tt> in Twisted, but there's essentially no
reason to ever use it.</p>
<p>smtpclient-5.tac adds a new import:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.mail</span> <span class="kn">import</span> <span class="n">smtp</span>
</pre></div>
<p>All of the mail related code in Twisted exists beneath
the <tt class="docutils literal">twisted.mail</tt> package.  More specifically, everything
having to do with the SMTP protocol implementation is defined in
the <tt class="docutils literal">twisted.mail.smtp</tt> module.</p>
<p>Next we remove a line we added in smtpclient-4.tac:</p>
<div class="highlight"><pre><span></span><span class="n">smtpClientFactory</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">Protocol</span>
</pre></div>
<p>And add a similar one in its place:</p>
<div class="highlight"><pre><span></span><span class="n">smtpClientFactory</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">smtp</span><span class="o">.</span><span class="n">ESMTPClient</span>
</pre></div>
<p>Our client factory is now using a protocol implementation which
behaves as an SMTP client.  What happens when we try to run this
version?</p>
<div class="highlight"><pre><span></span><span class="gp">exarkun@boson:~/doc/mail/tutorial/smtpclient$ </span>twistd -ny smtpclient-5.tac
<span class="go">19:42 EST [-] Log opened.</span>
<span class="go">19:42 EST [-] twistd SVN-Trunk (/usr/bin/python2.4 2.4.1) starting up</span>
<span class="go">19:42 EST [-] reactor class: twisted.internet.selectreactor.SelectReactor</span>
<span class="go">19:42 EST [-] Loading smtpclient-5.tac...</span>
<span class="go">19:42 EST [-] Loaded.</span>
<span class="go">19:42 EST [-] Starting factory &lt;twisted.internet.protocol.ClientFactory</span>
<span class="go">              instance at 0xb791e54c&gt;</span>
<span class="go">19:42 EST [-] Enabling Multithreading.</span>
<span class="go">19:42 EST [Uninitialized] Traceback (most recent call last):</span>
<span class="go">          File "twisted/python/log.py", line 56, in callWithLogger</span>
<span class="go">            return callWithContext({"system": lp}, func, *args, **kw)</span>
<span class="go">          File "twisted/python/log.py", line 41, in callWithContext</span>
<span class="go">            return context.call({ILogContext: newCtx}, func, *args, **kw)</span>
<span class="go">          File "twisted/python/context.py", line 52, in callWithContext</span>
<span class="go">            return self.currentContext().callWithContext(ctx, func, *args, **kw)</span>
<span class="go">          File "twisted/python/context.py", line 31, in callWithContext</span>
<span class="go">            return func(*args,**kw)</span>
<span class="go">        --- &lt;exception caught here&gt; ---</span>
<span class="go">          File "twisted/internet/selectreactor.py", line 139, in _doReadOrWrite</span>
<span class="go">            why = getattr(selectable, method)()</span>
<span class="go">          File "twisted/internet/tcp.py", line 543, in doConnect</span>
<span class="go">            self._connectDone()</span>
<span class="go">          File "twisted/internet/tcp.py", line 546, in _connectDone</span>
<span class="go">            self.protocol = self.connector.buildProtocol(self.getPeer())</span>
<span class="go">          File "twisted/internet/base.py", line 641, in buildProtocol</span>
<span class="go">            return self.factory.buildProtocol(addr)</span>
<span class="go">          File "twisted/internet/protocol.py", line 99, in buildProtocol</span>
<span class="go">            p = self.protocol()</span>
<span class="go">        exceptions.TypeError: __init__() takes at least 2 arguments (1 given)</span>

<span class="go">19:42 EST [Uninitialized] Stopping factory</span>
<span class="go">          &lt;twisted.internet.protocol.ClientFactory instance at</span>
<span class="go">          0xb791e54c&gt;</span>
<span class="go">19:43 EST [-] Received SIGINT, shutting down.</span>
<span class="go">19:43 EST [-] Main loop terminated.</span>
<span class="go">19:43 EST [-] Server Shut Down.</span>
<span class="gp">exarkun@boson:~/doc/mail/tutorial/smtpclient$</span>
</pre></div>
<p>Oops, back to getting a traceback.  This time, the default
implementation of <tt class="docutils literal">buildProtocol</tt> seems no longer to be
sufficient.  It instantiates the protocol with no arguments,
but <tt class="docutils literal">ESMTPClient</tt> wants at least one argument.  In the next
version of the client, we'll override <tt class="docutils literal">buildProtocol</tt> to
fix this problem.</p>
</div>
<div class="section" id="smtp-client-6">
<h2><a class="toc-backref" href="#id6">SMTP Client 6</a></h2>
<p><cite>smtpclient-6.tac</cite> introduces
a <tt class="docutils literal">twisted.internet.protocol.ClientFactory</tt> subclass with
an overridden <tt class="docutils literal">buildProtocol</tt> method to overcome the
problem encountered in the previous example.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SMTPClientFactory</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ClientFactory</span><span class="p">):</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">smtp</span><span class="o">.</span><span class="n">ESMTPClient</span>

    <span class="k">def</span> <span class="nf">buildProtocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">(</span><span class="n">secret</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">identity</span><span class="o">=</span><span class="s1">'example.com'</span><span class="p">)</span>
</pre></div>
<p>The overridden method does almost the same thing as the base
implementation: the only change is that it passes values for two
arguments to <tt class="docutils literal">twisted.mail.smtp.ESMTPClient</tt> 's initializer.
The <tt class="docutils literal">secret</tt> argument is used for SMTP authentication
(which we will not attempt yet).  The <tt class="docutils literal">identity</tt> argument
is used as a to identify ourselves Another minor change to note is
that the <tt class="docutils literal">protocol</tt> attribute is now defined in the class
definition, rather than tacked onto an instance after one is created.
This means it is a class attribute, rather than an instance attribute,
now, which makes no difference as far as this example is concerned.
There are circumstances in which the difference is important: be sure
you understand the implications of each approach when creating your
own factories.</p>
<p>One other change is required: instead of
instantiating <tt class="docutils literal">twisted.internet.protocol.ClientFactory</tt> , we
will now instantiate <tt class="docutils literal">SMTPClientFactory</tt> :</p>
<div class="highlight"><pre><span></span><span class="n">smtpClientFactory</span> <span class="o">=</span> <span class="n">SMTPClientFactory</span><span class="p">()</span>
</pre></div>
<p>Running this version of the code, we observe that the
code <strong>still</strong> isn't quite traceback-free.</p>
<div class="highlight"><pre><span></span><span class="gp">exarkun@boson:~/doc/mail/tutorial/smtpclient$ </span>twistd -ny smtpclient-6.tac
<span class="go">21:17 EST [-] Log opened.</span>
<span class="go">21:17 EST [-] twistd SVN-Trunk (/usr/bin/python2.4 2.4.1) starting up</span>
<span class="go">21:17 EST [-] reactor class: twisted.internet.selectreactor.SelectReactor</span>
<span class="go">21:17 EST [-] Loading smtpclient-6.tac...</span>
<span class="go">21:17 EST [-] Loaded.</span>
<span class="go">21:17 EST [-] Starting factory &lt;__builtin__.SMTPClientFactory instance</span>
<span class="go">              at 0xb77fd68c&gt;</span>
<span class="go">21:17 EST [-] Enabling Multithreading.</span>
<span class="go">21:17 EST [ESMTPClient,client] Traceback (most recent call last):</span>
<span class="go">          File "twisted/python/log.py", line 56, in callWithLogger</span>
<span class="go">            return callWithContext({"system": lp}, func, *args, **kw)</span>
<span class="go">          File "twisted/python/log.py", line 41, in callWithContext</span>
<span class="go">            return context.call({ILogContext: newCtx}, func, *args, **kw)</span>
<span class="go">          File "twisted/python/context.py", line 52, in callWithContext</span>
<span class="go">            return self.currentContext().callWithContext(ctx, func, *args, **kw)</span>
<span class="go">          File "twisted/python/context.py", line 31, in callWithContext</span>
<span class="go">            return func(*args,**kw)</span>
<span class="go">        --- &lt;exception caught here&gt; ---</span>
<span class="go">          File "twisted/internet/selectreactor.py", line 139, in _doReadOrWrite</span>
<span class="go">            why = getattr(selectable, method)()</span>
<span class="go">          File "twisted/internet/tcp.py", line 351, in doRead</span>
<span class="go">            return self.protocol.dataReceived(data)</span>
<span class="go">          File "twisted/protocols/basic.py", line 221, in dataReceived</span>
<span class="go">            why = self.lineReceived(line)</span>
<span class="go">          File "twisted/mail/smtp.py", line 1039, in lineReceived</span>
<span class="go">            why = self._okresponse(self.code,'\n'.join(self.resp))</span>
<span class="go">          File "twisted/mail/smtp.py", line 1281, in esmtpState_serverConfig</span>
<span class="go">            self.tryTLS(code, resp, items)</span>
<span class="go">          File "twisted/mail/smtp.py", line 1294, in tryTLS</span>
<span class="go">            self.authenticate(code, resp, items)</span>
<span class="go">          File "twisted/mail/smtp.py", line 1343, in authenticate</span>
<span class="go">            self.smtpState_from(code, resp)</span>
<span class="go">          File "twisted/mail/smtp.py", line 1062, in smtpState_from</span>
<span class="go">            self._from = self.getMailFrom()</span>
<span class="go">          File "twisted/mail/smtp.py", line 1137, in getMailFrom</span>
<span class="go">            raise NotImplementedError</span>
<span class="go">        exceptions.NotImplementedError:</span>

<span class="go">21:17 EST [ESMTPClient,client] Stopping factory</span>
<span class="go">          &lt;__builtin__.SMTPClientFactory instance at 0xb77fd68c&gt;</span>
<span class="go">21:17 EST [-] Received SIGINT, shutting down.</span>
<span class="go">21:17 EST [-] Main loop terminated.</span>
<span class="go">21:17 EST [-] Server Shut Down.</span>
<span class="gp">exarkun@boson:~/doc/mail/tutorial/smtpclient$</span>
</pre></div>
<p>What we have accomplished with this iteration of the example is to
navigate far enough into an SMTP transaction that Twisted is now
interested in calling back to application-level code to determine what
its next step should be.  In the next example, we'll see how to
provide that information to it.</p>
</div>
<div class="section" id="smtp-client-7">
<h2><a class="toc-backref" href="#id7">SMTP Client 7</a></h2>
<p>SMTP Client 7 is the first version of our SMTP client which
actually includes message data to transmit.  For simplicity's sake,
the message is defined as part of a new class.  In a useful program
which sent email, message data might be pulled in from the filesystem,
a database, or be generated based on
user-input.  <cite>smtpclient-7.tac</cite> , however,
defines a new class, <tt class="docutils literal">SMTPTutorialClient</tt> , with three class
attributes (<tt class="docutils literal">mailFrom</tt> , <tt class="docutils literal">mailTo</tt> ,
and <tt class="docutils literal">mailData</tt> ):</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SMTPTutorialClient</span><span class="p">(</span><span class="n">smtp</span><span class="o">.</span><span class="n">ESMTPClient</span><span class="p">):</span>
    <span class="n">mailFrom</span> <span class="o">=</span> <span class="s2">"tutorial_sender@example.com"</span>
    <span class="n">mailTo</span> <span class="o">=</span> <span class="s2">"tutorial_recipient@example.net"</span>
    <span class="n">mailData</span> <span class="o">=</span> <span class="s1">'''</span><span class="se">\</span>
<span class="s1">Date: Fri, 6 Feb 2004 10:14:39 -0800</span>
<span class="s1">From: Tutorial Guy &lt;tutorial_sender@example.com&gt;</span>
<span class="s1">To: Tutorial Gal &lt;tutorial_recipient@example.net&gt;</span>
<span class="s1">Subject: Tutorate!</span>

<span class="s1">Hello, how are you, goodbye.</span>
<span class="s1">'''</span>
</pre></div>
<p>This statically defined data is accessed later in the class
definition by three of the methods which are part of the
<em>SMTPClient callback API</em> .  Twisted expects each of the three
methods below to be defined and to return an object with a particular
meaning.  First, <tt class="docutils literal">getMailFrom</tt> :</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">getMailFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mailFrom</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mailFrom</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
<p>This method is called to determine the <em>reverse-path</em> ,
otherwise known as the <em>envelope from</em> , of the message.  This
value will be used when sending the <tt class="docutils literal">MAIL FROM</tt> SMTP
command.  The method must return a string which conforms to the <a class="reference external" href="http://www.faqs.org/rfcs/rfc2821.html">RFC 2821</a> definition
of a <em>reverse-path</em> .  In simpler terms, it should be a string
like <tt class="docutils literal">"alice@example.com"</tt> .  Only one <em>envelope from</em> is allowed by the SMTP protocol, so it cannot be a list of
strings or a comma separated list of addresses.  Our implementation
of <tt class="docutils literal">getMailFrom</tt> does a little bit more than just return a
string; we'll get back to this in a little bit.</p>
<p>The next method is <tt class="docutils literal">getMailTo</tt> :</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">getMailTo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mailTo</span><span class="p">]</span>
</pre></div>
<p><tt class="docutils literal">getMailTo</tt> is similar to <tt class="docutils literal">getMailFrom</tt> .  It
returns one or more RFC 2821 addresses (this time a
<em>forward-path</em> , or <em>envelope to</em> ).  Since SMTP allows
multiple recipients, <tt class="docutils literal">getMailTo</tt> returns a list of these
addresses.  The list must contain at least one address, and even if
there is exactly one recipient, it must still be in a list.</p>
<p>The final callback we will define to provide information to
Twisted is <tt class="docutils literal">getMailData</tt> :</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">getMailData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mailData</span><span class="p">)</span>
</pre></div>
<p>This one is quite simple as well: it returns a file or a file-like
object which contains the message contents.  In our case, we return
a <tt class="docutils literal">StringIO</tt> since we already have a string containing our
message.  If the contents of the file returned
by <tt class="docutils literal">getMailData</tt> span multiple lines (as email messages
often do), the lines should be <tt class="docutils literal">\n</tt> delimited (as they
would be when opening a text file in the <tt class="docutils literal">"rt"</tt> mode):
necessary newline translation will be performed
by <tt class="docutils literal">SMTPClient</tt> automatically.</p>
<p>There is one more new callback method defined in smtpclient-7.tac.
This one isn't for providing information about the messages to
Twisted, but for Twisted to provide information about the success or
failure of the message transmission to the application:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sentMail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="n">numOk</span><span class="p">,</span> <span class="n">addresses</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'Sent'</span><span class="p">,</span> <span class="n">numOk</span><span class="p">,</span> <span class="s1">'messages'</span><span class="p">)</span>
</pre></div>
<p>Each of the arguments to <tt class="docutils literal">sentMail</tt> provides some
information about the success or failure of the message transmission
transaction.  <tt class="docutils literal">code</tt> is the response code from the ultimate
command.  For successful transactions, it will be 250.  For transient
failures (those which should be retried), it will be between 400 and
499, inclusive.  For permanent failures (this which will never work,
no matter how many times you retry them), it will be between 500 and
599.</p>
</div>
<div class="section" id="smtp-client-8">
<h2><a class="toc-backref" href="#id8">SMTP Client 8</a></h2>
<p>Thus far we have succeeded in creating a Twisted client application
which starts up, connects to a (possibly) remote host, transmits some
data, and disconnects.  Notably missing, however, is application
shutdown.  Hitting ^C is fine during development, but it's not exactly
a long-term solution.  Fortunately, programmatic shutdown is extremely
simple.  <cite>smtpclient-8.tac</cite>
extends <tt class="docutils literal">sentMail</tt> with these two lines:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
<p>The <tt class="docutils literal">stop</tt> method of the reactor causes the main event
loop to exit, allowing a Twisted server to shut down.  With this
version of the example, we see that the program actually terminates
after sending the message, without user-intervention:</p>
<div class="highlight"><pre><span></span><span class="gp">exarkun@boson:~/doc/mail/tutorial/smtpclient$ </span>twistd -ny smtpclient-8.tac
<span class="go">19:52 EST [-] Log opened.</span>
<span class="go">19:52 EST [-] twistd SVN-Trunk (/usr/bin/python2.4 2.4.1) starting up</span>
<span class="go">19:52 EST [-] reactor class: twisted.internet.selectreactor.SelectReactor</span>
<span class="go">19:52 EST [-] Loading smtpclient-8.tac...</span>
<span class="go">19:52 EST [-] Loaded.</span>
<span class="go">19:52 EST [-] Starting factory &lt;__builtin__.SMTPClientFactory instance</span>
<span class="go">              at 0xb791beec&gt;</span>
<span class="go">19:52 EST [-] Enabling Multithreading.</span>
<span class="go">19:52 EST [SMTPTutorialClient,client] Sent 1 messages</span>
<span class="go">19:52 EST [SMTPTutorialClient,client] Stopping factory</span>
<span class="go">          &lt;__builtin__.SMTPClientFactory instance at 0xb791beec&gt;</span>
<span class="go">19:52 EST [-] Main loop terminated.</span>
<span class="go">19:52 EST [-] Server Shut Down.</span>
<span class="gp">exarkun@boson:~/doc/mail/tutorial/smtpclient$</span>
</pre></div>
</div>
<div class="section" id="smtp-client-9">
<h2><a class="toc-backref" href="#id9">SMTP Client 9</a></h2>
<p>One task remains to be completed in this tutorial SMTP client:
instead of always sending mail through a well-known host, we will look
up the mail exchange server for the recipient address and try to
deliver the message to that host.</p>
<p>In <cite>smtpclient-9.tac</cite> , we'll take the
first step towards this feature by defining a function which returns
the mail exchange host for a particular domain:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">getMailExchange</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">'localhost'</span>
</pre></div>
<p>Obviously this doesn't return the correct mail exchange host yet
(in fact, it returns the exact same host we have been using all
along), but pulling out the logic for determining which host to
connect to into a function like this is the first step towards our
ultimate goal.  Now that we have <tt class="docutils literal">getMailExchange</tt> , we'll
call it when constructing our <tt class="docutils literal">TCPClient</tt> service:</p>
<div class="highlight"><pre><span></span><span class="n">smtpClientService</span> <span class="o">=</span> <span class="n">internet</span><span class="o">.</span><span class="n">TCPClient</span><span class="p">(</span>
    <span class="n">getMailExchange</span><span class="p">(</span><span class="s1">'example.net'</span><span class="p">),</span> <span class="mi">25</span><span class="p">,</span> <span class="n">smtpClientFactory</span><span class="p">)</span>
</pre></div>
<p>We'll expand on the definition of <tt class="docutils literal">getMailExchange</tt> in
the next example.</p>
</div>
<div class="section" id="smtp-client-10">
<h2><a class="toc-backref" href="#id10">SMTP Client 10</a></h2>
<p>In the previous example we defined <tt class="docutils literal">getMailExchange</tt> to
return a string representing the mail exchange host for a particular
domain.  While this was a step in the right direction, it turns out
not to be a very big one.  Determining the mail exchange host for a
particular domain is going to involve network traffic (specifically,
some DNS requests).  These might take an arbitrarily large amount of
time, so we need to introduce a <tt class="docutils literal">Deferred</tt> to represent the
result of <tt class="docutils literal">getMailExchange</tt> .  <cite>smtpclient-10.tac</cite> redefines it
thusly:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">getMailExchange</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">defer</span><span class="o">.</span><span class="n">succeed</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">)</span>
</pre></div>
<p><tt class="docutils literal">defer.succeed</tt> is a function which creates a
new <tt class="docutils literal">Deferred</tt> which already has a result, in this
case <tt class="docutils literal">'localhost'</tt> .  Now we need to adjust
our <tt class="docutils literal">TCPClient</tt> -constructing code to expect and properly
handle this <tt class="docutils literal">Deferred</tt> :</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cbMailExchange</span><span class="p">(</span><span class="n">exchange</span><span class="p">):</span>
    <span class="n">smtpClientFactory</span> <span class="o">=</span> <span class="n">SMTPClientFactory</span><span class="p">()</span>

    <span class="n">smtpClientService</span> <span class="o">=</span> <span class="n">internet</span><span class="o">.</span><span class="n">TCPClient</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">smtpClientFactory</span><span class="p">)</span>
    <span class="n">smtpClientService</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span><span class="n">application</span><span class="p">)</span>

<span class="n">getMailExchange</span><span class="p">(</span><span class="s1">'example.net'</span><span class="p">)</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">cbMailExchange</span><span class="p">)</span>
</pre></div>
<p>An in-depth exploration of <tt class="docutils literal">Deferred</tt> s is beyond the
scope of this document.  For such a look, see
the <a class="reference external" href="../../../core/howto/defer.html">Deferred Reference</a> <tt class="docutils literal">TCPClient</tt> until the <tt class="docutils literal">Deferred</tt>
returned by <tt class="docutils literal">getMailExchange</tt> fires.  Once it does, we
proceed normally through the creation of
our <tt class="docutils literal">SMTPClientFactory</tt> and <tt class="docutils literal">TCPClient</tt> , as well
as set the <tt class="docutils literal">TCPClient</tt> 's service parent, just as we did in
the previous examples.</p>
</div>
<div class="section" id="smtp-client-11">
<h2><a class="toc-backref" href="#id11">SMTP Client 11</a></h2>
<p>At last we're ready to perform the mail exchange lookup.  We do
this by calling on an object provided specifically for this
task, <tt class="docutils literal">twisted.mail.relaymanager.MXCalculator</tt> :</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">getMailExchange</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">cbMX</span><span class="p">(</span><span class="n">mxRecord</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">mxRecord</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">relaymanager</span><span class="o">.</span><span class="n">MXCalculator</span><span class="p">()</span><span class="o">.</span><span class="n">getMX</span><span class="p">(</span><span class="n">host</span><span class="p">)</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">cbMX</span><span class="p">)</span>
</pre></div>
<p>Because <tt class="docutils literal">getMX</tt> returns a <tt class="docutils literal">Record_MX</tt> object
rather than a string, we do a little bit of post-processing to get the
results we want.  We have already converted the rest of the tutorial
application to expect a <tt class="docutils literal">Deferred</tt>
from <tt class="docutils literal">getMailExchange</tt> , so no further changes are
required.  <cite>smtpclient-11.tac</cite> completes
this tutorial by being able to both look up the mail exchange host for
the recipient domain, connect to it, complete an SMTP transaction,
report its results, and finally shut down the reactor.</p>
<!-- TODO: write a conclusion to wrap it up -->

</div>

        </div>
        </div>
        </div>
<div class="sphinxsidebar">
<div class="sphinxsidebarwrapper">
<div class="toc" id="">
<p class="topic-title">Table Of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#smtp-client-1" id="id1">SMTP Client 1</a></li>
<li><a class="reference internal" href="#smtp-client-2" id="id2">SMTP Client 2</a></li>
<li><a class="reference internal" href="#smtp-client-3" id="id3">SMTP Client 3</a></li>
<li><a class="reference internal" href="#smtp-client-4" id="id4">SMTP Client 4</a></li>
<li><a class="reference internal" href="#smtp-client-5" id="id5">SMTP Client 5</a></li>
<li><a class="reference internal" href="#smtp-client-6" id="id6">SMTP Client 6</a></li>
<li><a class="reference internal" href="#smtp-client-7" id="id7">SMTP Client 7</a></li>
<li><a class="reference internal" href="#smtp-client-8" id="id8">SMTP Client 8</a></li>
<li><a class="reference internal" href="#smtp-client-9" id="id9">SMTP Client 9</a></li>
<li><a class="reference internal" href="#smtp-client-10" id="id10">SMTP Client 10</a></li>
<li><a class="reference internal" href="#smtp-client-11" id="id11">SMTP Client 11</a></li>
</ul>
</div>
</div>
</div>    </div>

    </section>

        <div id="footer"><hr>
                <div> </div>
                <p class="left2">
        Copyright 2021, Twisted Matrix Labs. Ver 21.2.0. Built on 2021-02-28.<br />
        Site design<br />
        By <a href="http://huw.ugbox.net/">huw.wilkins.</a>

                </p>
                <p class="right"></p>
        </div>


</body>
</html>