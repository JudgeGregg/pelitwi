<!DOCTYPE html>
<html lang="en">
<head>
          <title>Test Pelican - Using Threads in Twisted</title>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />

        <meta name="Description" content="An event-driven networking engine written in Python and MIT licensed." />

        <link rel="stylesheet" type="text/css" href="https://judgegregg.github.io/pelitwi/theme/css/twistedtrac.css" />


</head>

<body>
        <div id="banner">
                <div id="top_grad"></div>
                <div id="tab">
                        <a href="https://twistedmatrix.com/trac/wiki">HOME</a>
                        <a href="https://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions">FAQ</a>
                        <a href="/">DOCS</a>
                        <a href="https://twistedmatrix.com/trac/wiki/Downloads">DOWNLOAD</a>
                </div>

                <div id="header">
                        <a id="logo" href="https://judgegregg.github.io/pelitwi/"><img src="https://judgegregg.github.io/pelitwi/theme/images/trac_banner.png" alt="Twisted" /></a>
                </div>
        </div>

<div id="mainnav" class="related">
	<ul>
		<li><a href="https://judgegregg.github.io/pelitwi">Twisted 21.2.0 documentation</a> Â»</li>
	</ul>
</div>
        <div id="ctxtnav" class="nav">
        </div>

    <section>

    <div class="document">
        <div class="documentwrapper">
        <div class="bodywrapper">
        <h1>Using Threads in Twisted</h1>
        
        <div class="entry-content">
        <div class="section" id="how-twisted-uses-threads-itself">
<h2><a class="toc-backref" href="#id1">How Twisted Uses Threads Itself</a></h2>
<p>All callbacks registered with the reactor - for example, <tt class="docutils literal">dataReceived</tt>, <tt class="docutils literal">connectionLost</tt>, or any higher-level method that comes from these, such as <tt class="docutils literal">render_GET</tt> in twisted.web, or a callback added to a <tt class="docutils literal">Deferred</tt> - are called from <tt class="docutils literal">reactor.run</tt>.
The terminology around this is that we say these callbacks are run in the "main thread", or "reactor thread" or "I/O thread".</p>
<p>Therefore, internally, Twisted makes very little use of threads.
This is not to say that it makes <em>no</em> use of threads; there are plenty of APIs which have no non-blocking equivalent, so when Twisted needs to call those, it calls them in a thread.
One prominent example of this is system hostname resolution: unless you have configured Twisted to use its own DNS client in <tt class="docutils literal">twisted.names</tt>, it will have to use your operating system's blocking APIs to map host names to IP addresses, in the reactor's thread pool.
However, this is something you only need to know about for resource-tuning purposes, like setting the number of threads to use; otherwise, it is an implementation detail you can ignore.</p>
<p>It is a common mistake is to think that because Twisted can manage multiple connections once, things are happening in multiple threads, and so you need to carefully manage locks.
Lucky for you, Twisted does most things in one thread!
This document will explain how to interact with existing APIs which need to be run within their own threads because they block.
If you're just using Twisted's own APIs, the rule for threads is simply "don't use them".</p>
</div>
<div class="section" id="invoking-twisted-from-other-threads">
<h2><a class="toc-backref" href="#id2">Invoking Twisted From Other Threads</a></h2>
<p>Methods within Twisted may only be invoked from the reactor thread unless otherwise noted.
Very few things within Twisted are thread-safe.
For example, writing data to a transport from a protocol is not thread-safe.
This means that if you start a thread and call a Twisted method, you might get correct behavior... or you might get hangs, crashes, or corrupted data.
So don't do it.</p>
<p>The right way to call methods on the reactor from another thread, and therefore any objects which might call methods on the reactor, is to give a function to the reactor to execute within its own thread.
This can be done using the function <cite>callFromThread &lt;twisted.internet.interfaces.IReactorFromThreads.callFromThread&gt;</cite>:</p>
<pre class="literal-block">
from twisted.internet import reactor
def notThreadSafe(someProtocol, message):
    someProtocol.transport.write(b"a message: " + message)
def callFromWhateverThreadYouWant():
    reactor.callFromThread(notThreadSafe, b"hello")
</pre>
<p>In this example, <tt class="docutils literal">callFromWhateverThreadYouWant</tt> is thread-safe and can be invoked by any thread, but <tt class="docutils literal">notThreadSafe</tt> should only ever be called by code running in the thread where <tt class="docutils literal">reactor.run</tt> is running.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There are many objects within Twisted that represent values - for example, <cite>FilePath &lt;twisted.python.filepath.FilePath&gt;</cite> and <cite>URLPath &lt;twisted.python.urlpath.URLPath&gt;</cite> - which you may construct yourself.
These may be safely constructed and used within a non-reactor thread as long as they are not shared with other threads.
However, you should be sure that these objects do not share any state, especially not with the reactor.
One good rule of thumb is that any object whose methods return <tt class="docutils literal">Deferred</tt>s is almost certainly touching the reactor at some point, and should never be accessed from a non-reactor thread.</p>
</div>
</div>
<div class="section" id="running-code-in-threads">
<h2><a class="toc-backref" href="#id3">Running Code In Threads</a></h2>
<p>Sometimes we may want to run code in a non-reactor thread, to avoid blocking the reactor.
Twisted provides an API for doing so, the <cite>callInThread &lt;twisted.internet.interfaces.IReactorInThreads.callInThread&gt;</cite> method on the reactor.</p>
<p>For example, to run a method in a non-reactor thread we can do:</p>
<pre class="literal-block">
from __future__ import print_function
from twisted.internet import reactor

def aSillyBlockingMethod(x):
    import time
    time.sleep(2)
    print(x)

reactor.callInThread(aSillyBlockingMethod, "2 seconds have passed")
reactor.run()
</pre>
<p><tt class="docutils literal">callInThread</tt> will put your code into a queue, to be run by the next available thread in the reactor's thread pool.
This means that depending on what other work has been submitted to the pool, your method may not run immediately.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Keep in mind that <tt class="docutils literal">callInThread</tt> can only concurrently run a fixed maximum number of tasks, and all users of the reactor are sharing that limit.
Therefore, you should not submit <em>tasks which depend on other tasks in order to complete</em> to be executed by <tt class="docutils literal">callInThread</tt>.
An example of such a task would be something like this:</p>
<pre class="literal-block">
from __future__ import print_function

q = Queue()
def blocker():
    print(q.get() + q.get())
def unblocker(a, b):
    q.put(a)
    q.put(b)
</pre>
<p>In this case, <tt class="docutils literal">blocker</tt> will block <em>forever</em> unless <tt class="docutils literal">unblocker</tt> can successfully run to give it inputs; similarly, <tt class="docutils literal">unblocker</tt> might block forever if <tt class="docutils literal">blocker</tt> is not run to consume its outputs.
So if you had a threadpool of maximum size X, and you ran <tt class="docutils literal">for each in range(X): reactor.callInThread(blocker)</tt>, the reactor threadpool would be wedged forever, unable to process more work or even shut down.</p>
<p class="last">See "Managing the Reactor Thread Pool" below to tune these limits.</p>
</div>
</div>
<div class="section" id="getting-results">
<h2><a class="toc-backref" href="#id4">Getting Results</a></h2>
<p>callInThread and callFromThread allow you to move the execution of your code out of and into the reactor thread, respectively, but that isn't always enough.</p>
<p>When we run some code, we often want to know what its result was.  For this, Twisted provides two methods: <cite>deferToThread &lt;twisted.internet.threads.deferToThread&gt;</cite> and <cite>blockingCallFromThread &lt;twisted.internet.threads.blockingCallFromThread&gt;</cite>, defined in the <tt class="docutils literal">twisted.internet.threads</tt> module.</p>
<p>To get a result from some blocking code back into the reactor thread, we can use <cite>deferToThread &lt;twisted.internet.threads.deferToThread&gt;</cite> to execute it instead of callFromThread.</p>
<pre class="literal-block">
from __future__ import print_function
from twisted.internet import reactor, threads

def doLongCalculation():
    # .... do long calculation here ...
    return 3

def printResult(x):
    print(x)

# run method in thread and get result as defer.Deferred
d = threads.deferToThread(doLongCalculation)
d.addCallback(printResult)
reactor.run()
</pre>
<p>Similarly, you want some code running in a non-reactor thread wants to invoke some code in the reactor thread and get its result, you can use <cite>blockingCallFromThread &lt;twisted.internet.threads.blockingCallFromThread&gt;</cite>:</p>
<pre class="literal-block">
from twisted.internet import threads, reactor, defer
from twisted.web.client import Agent
from twisted.web.error import Error

def inThread():
    agent = Agent(reactor)
    try:
        result = threads.blockingCallFromThread(
            reactor, agent.request, "GET", "http://twistedmatrix.com/"))
    except Error as exc:
        print(exc)
    else:
        print(result)
    reactor.callFromThread(reactor.stop)

reactor.callInThread(inThread)
reactor.run()
</pre>
<p><tt class="docutils literal">blockingCallFromThread</tt> will return the object or raise the exception returned or raised by the function passed to it.
If the function passed to it returns a Deferred, it will return the value the Deferred is called back with or raise the exception it is errbacked with.</p>
</div>
<div class="section" id="managing-the-reactor-thread-pool">
<h2><a class="toc-backref" href="#id5">Managing the Reactor Thread Pool</a></h2>
<p>We may want to modify the size of the thread pool, increasing or decreasing the number of threads in use.
We can do this:</p>
<pre class="literal-block">
from twisted.internet import reactor

reactor.suggestThreadPoolSize(30)
</pre>
<p>The default size of the thread pool depends on the reactor being used; the default reactor uses a minimum size of 0 and a maximum size of 10.</p>
<p>The reactor thread pool is implemented by <cite>ThreadPool &lt;twisted.python.threadpool.ThreadPool&gt;</cite>.
To access methods on this object for more advanced tuning and monitoring (see the API documentation for details) you can get the thread pool with <cite>getThreadPool &lt;twisted.internet.interfaces.IReactorThreads.getThreadPool&gt;</cite>.</p>

</div>

        </div>
        </div>
        </div>
<div class="sphinxsidebar">
<div class="sphinxsidebarwrapper">
<div class="toc" id="">
<p class="topic-title">Table Of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#how-twisted-uses-threads-itself" id="id1">How Twisted Uses Threads Itself</a></li>
<li><a class="reference internal" href="#invoking-twisted-from-other-threads" id="id2">Invoking Twisted From Other Threads</a></li>
<li><a class="reference internal" href="#running-code-in-threads" id="id3">Running Code In Threads</a></li>
<li><a class="reference internal" href="#getting-results" id="id4">Getting Results</a></li>
<li><a class="reference internal" href="#managing-the-reactor-thread-pool" id="id5">Managing the Reactor Thread Pool</a></li>
</ul>
</div>
</div>
</div>    </div>

    </section>

        <div id="footer"><hr>
                <div> </div>
                <p class="left2">
        Copyright 2021, Twisted Matrix Labs. Ver 21.2.0. Built on 2021-02-28.<br />
        Site design<br />
        By <a href="http://huw.ugbox.net/">huw.wilkins.</a>

                </p>
                <p class="right"></p>
        </div>


</body>
</html>