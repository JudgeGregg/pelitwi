<!DOCTYPE html>
<html lang="en">
<head>
          <title>Test Pelican - Asynchronous Messaging Protocol Overview</title>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />

        <meta name="Description" content="An event-driven networking engine written in Python and MIT licensed." />

        <link rel="stylesheet" type="text/css" href="https://judgegregg.github.io/pelitwi/theme/css/twistedtrac.css" />


</head>

<body>
        <div id="banner">
                <div id="top_grad"></div>
                <div id="tab">
                        <a href="https://twistedmatrix.com/trac/wiki">HOME</a>
                        <a href="https://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions">FAQ</a>
                        <a href="/">DOCS</a>
                        <a href="https://twistedmatrix.com/trac/wiki/Downloads">DOWNLOAD</a>
                </div>

                <div id="header">
                        <a id="logo" href="https://judgegregg.github.io/pelitwi/"><img src="https://judgegregg.github.io/pelitwi/theme/images/trac_banner.png" alt="Twisted" /></a>
                </div>
        </div>

<div id="mainnav" class="related">
	<ul>
		<li><a href="https://judgegregg.github.io/pelitwi">Twisted 21.2.0 documentation</a> Â»</li>
	</ul>
</div>
        <div id="ctxtnav" class="nav">
        </div>

    <section>

    <div class="document">
        <div class="documentwrapper">
        <div class="bodywrapper">
        <h1>Asynchronous Messaging Protocol Overview</h1>
        
        <div class="entry-content">
        <p>The purpose of this guide is to describe the uses for and usage of <cite>twisted.protocols.amp</cite> beyond what is explained in the API documentation.  It will show you how to implement an AMP server which can respond to commands or interact directly with individual messages.  It will also show you how to implement an AMP client which can issue commands to a server.</p>
<p>AMP is a bidirectional command/response-oriented protocol intended to be extended with application-specific request types and handlers.  Various simple data types are supported and support for new data types can be added by applications.</p>
<div class="section" id="setting-up">
<h2><a class="toc-backref" href="#id1">Setting Up</a></h2>
<p>AMP runs over a stream-oriented connection-based protocol, such as TCP or SSL.  Before you can use any features of the AMP protocol, you need a connection.  The protocol class to use to establish an AMP connection is <cite>AMP &lt;twisted.protocols.amp.AMP&gt;</cite> .  Connection setup works as it does for almost all protocols in Twisted.  For example, you can set up a listening AMP server using a server endpoint:</p>
<p><cite>basic_server.tac &lt;listings/amp/basic_server.tac&gt;</cite></p>
<p>And you can connect to an AMP server using a client endpoint:</p>
<p><cite>basic_client.py &lt;listings/amp/basic_client.py&gt;</cite></p>
</div>
<div class="section" id="commands">
<h2><a class="toc-backref" href="#id2">Commands</a></h2>
<p>Either side of an AMP connection can issue a command to the other side.  Each kind of command is represented as a subclass of <cite>Command &lt;twisted.protocols.amp.Command&gt;</cite> .  A <tt class="docutils literal">Command</tt> defines arguments, response values, and error conditions.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.protocols.amp</span> <span class="kn">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Unicode</span><span class="p">,</span> <span class="n">Command</span>

<span class="k">class</span> <span class="nc">UsernameUnavailable</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">RegisterUser</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">'username'</span><span class="p">,</span> <span class="n">Unicode</span><span class="p">()),</span>
                 <span class="p">(</span><span class="s1">'publickey'</span><span class="p">,</span> <span class="n">String</span><span class="p">())]</span>

    <span class="n">response</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">'uid'</span><span class="p">,</span> <span class="n">Integer</span><span class="p">())]</span>

    <span class="n">errors</span> <span class="o">=</span> <span class="p">{</span><span class="n">UsernameUnavailable</span><span class="p">:</span> <span class="s1">'username-unavailable'</span><span class="p">}</span>
</pre></div>
<p>The definition of the command's signature - its arguments, response, and possible error conditions - is separate from the implementation of the behavior to execute when the command is received.  The <tt class="docutils literal">Command</tt> subclass only defines the former.</p>
<p>Commands are issued by calling <tt class="docutils literal">callRemote</tt> on either side of the connection.  This method returns a <tt class="docutils literal">Deferred</tt> which eventually fires with the result of the command.</p>
<p><cite>command_client.py &lt;listings/amp/command_client.py&gt;</cite></p>
</div>
<div class="section" id="locators">
<h2><a class="toc-backref" href="#id3">Locators</a></h2>
<p>The logic for handling a command can be specified as an object separate from the <tt class="docutils literal">AMP</tt> instance which interprets and formats bytes over the network.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.protocols.amp</span> <span class="kn">import</span> <span class="n">CommandLocator</span>
<span class="kn">from</span> <span class="nn">twisted.python.filepath</span> <span class="kn">import</span> <span class="n">FilePath</span>

<span class="k">class</span> <span class="nc">UsernameUnavailable</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">UserRegistration</span><span class="p">(</span><span class="n">CommandLocator</span><span class="p">):</span>
    <span class="n">uidCounter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="nd">@RegisterUser</span><span class="o">.</span><span class="n">responder</span>
    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">publickey</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">FilePath</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">UsernameUnavailable</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uidCounter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">path</span><span class="o">.</span><span class="n">setContent</span><span class="p">(</span><span class="s1">'</span><span class="si">%d</span><span class="s1"> </span><span class="si">%s</span><span class="se">\n</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uidCounter</span><span class="p">,</span> <span class="n">publickey</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">uidCounter</span>
</pre></div>
<p>When you define a separate <tt class="docutils literal">CommandLocator</tt> subclass, use it by passing an instance of it to the <tt class="docutils literal">AMP</tt> initializer.</p>
<div class="highlight"><pre><span></span><span class="n">factory</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">()</span>
<span class="n">factory</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">AMP</span><span class="p">(</span><span class="n">locator</span><span class="o">=</span><span class="n">UserRegistration</span><span class="p">())</span>
</pre></div>
<p>If no locator is passed in, <tt class="docutils literal">AMP</tt> acts as its own locator.  Command responders can be defined on an <tt class="docutils literal">AMP</tt> subclass, just as the responder was defined on the <tt class="docutils literal">UserRegistration</tt> example above.</p>
</div>
<div class="section" id="box-receivers">
<h2><a class="toc-backref" href="#id4">Box Receivers</a></h2>
<p>AMP conversations consist of an exchange of messages called <em>boxes</em> .  A <em>box</em> consists of a sequence of pairs of key and value (for example, the pair <tt class="docutils literal">username</tt> and <tt class="docutils literal">alice</tt> ).  Boxes are generally represented as <tt class="docutils literal">dict</tt> instances.  Normally boxes are passed back and forth to implement the command request/response features described above.  The logic for handling each box can be specified as an object separate from the <tt class="docutils literal">AMP</tt> instance.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">zope.interface</span> <span class="kn">import</span> <span class="n">implementer</span>

<span class="kn">from</span> <span class="nn">twisted.protocols.amp</span> <span class="kn">import</span> <span class="n">IBoxReceiver</span>

<span class="nd">@implementer</span><span class="p">(</span><span class="n">IBoxReceiver</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">BoxReflector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">startReceivingBoxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boxSender</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxSender</span> <span class="o">=</span> <span class="n">boxSender</span>

    <span class="k">def</span> <span class="nf">ampBoxReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxSender</span><span class="o">.</span><span class="n">sendBox</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stopReceivingBoxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxSender</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
<p>These methods parallel those of <tt class="docutils literal">IProtocol</tt> .  Startup notification is given by <tt class="docutils literal">startReceivingBoxes</tt> .  The argument passed to it is an <tt class="docutils literal">IBoxSender</tt> provider, which can be used to send boxes back out over the network.  <tt class="docutils literal">ampBoxReceived</tt> delivers notification for a complete box having been received.  And last, <tt class="docutils literal">stopReceivingBoxes</tt> notifies the object that no more boxes will be received and no more can be sent.  The argument passed to it is a <tt class="docutils literal">Failure</tt> which may contain details about what caused the conversation to end.</p>
<p>To use a custom <tt class="docutils literal">IBoxReceiver</tt> , pass it to the <tt class="docutils literal">AMP</tt> initializer.</p>
<div class="highlight"><pre><span></span><span class="n">factory</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">()</span>
<span class="n">factory</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">AMP</span><span class="p">(</span><span class="n">boxReceiver</span><span class="o">=</span><span class="n">BoxReflector</span><span class="p">())</span>
</pre></div>
<p>If no box receiver is passed in, <tt class="docutils literal">AMP</tt> acts as its own box receiver.  It handles boxes by treating them as command requests or responses and delivering them to the appropriate responder or as a result to a <tt class="docutils literal">callRemote</tt> <tt class="docutils literal">Deferred</tt> .</p>

</div>

        </div>
        </div>
        </div>
<div class="sphinxsidebar">
<div class="sphinxsidebarwrapper">
<div class="toc" id="">
<p class="topic-title">Table Of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#setting-up" id="id1">Setting Up</a></li>
<li><a class="reference internal" href="#commands" id="id2">Commands</a></li>
<li><a class="reference internal" href="#locators" id="id3">Locators</a></li>
<li><a class="reference internal" href="#box-receivers" id="id4">Box Receivers</a></li>
</ul>
</div>
</div>
</div>    </div>

    </section>

        <div id="footer"><hr>
                <div> </div>
                <p class="left2">
        Copyright 2021, Twisted Matrix Labs. Ver 21.2.0. Built on 2021-02-28.<br />
        Site design<br />
        By <a href="http://huw.ugbox.net/">huw.wilkins.</a>

                </p>
                <p class="right"></p>
        </div>


</body>
</html>