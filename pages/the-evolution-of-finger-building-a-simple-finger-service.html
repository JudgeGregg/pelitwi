<!DOCTYPE html>
<html lang="en">
<head>
          <title>Test Pelican - The Evolution of Finger: building a simple finger service</title>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />

        <meta name="Description" content="An event-driven networking engine written in Python and MIT licensed." />

        <link rel="stylesheet" type="text/css" href="https://judgegregg.github.io/pelitwi/theme/css/twistedtrac.css" />


</head>

<body>
        <div id="banner">
                <div id="top_grad"></div>
                <div id="tab">
                        <a href="https://twistedmatrix.com/trac/wiki">HOME</a>
                        <a href="https://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions">FAQ</a>
                        <a href="/">DOCS</a>
                        <a href="https://twistedmatrix.com/trac/wiki/Downloads">DOWNLOAD</a>
                </div>

                <div id="header">
                        <a id="logo" href="https://judgegregg.github.io/pelitwi/"><img src="https://judgegregg.github.io/pelitwi/theme/images/trac_banner.png" alt="Twisted" /></a>
                </div>
        </div>

<div id="mainnav" class="related">
	<ul>
		<li><a href="https://judgegregg.github.io/pelitwi">Twisted 21.2.0 documentation</a> »</li>
	</ul>
</div>
        <div id="ctxtnav" class="nav">
        </div>

    <section>

    <div class="document">
        <div class="documentwrapper">
        <div class="bodywrapper">
        <h1>The Evolution of Finger: building a simple finger service</h1>
        
        <div class="entry-content">
        <div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">Introduction</a></h2>
<p>This is the first part of the Twisted tutorial <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/twisted-from-scratch-or-the-evolution-of-finger.html">Twisted from Scratch, or The Evolution of Finger</a> .</p>
<p>If you're not familiar with 'finger' it's probably because it's not used as
much nowadays as it used to be. Basically, if you run <tt class="docutils literal">finger nail</tt>
or <tt class="docutils literal">finger nail@example.com</tt> the target computer spits out some
information about the user named <tt class="docutils literal">nail</tt> . For instance:</p>
<div class="highlight"><pre><span></span><span class="go">Login: nail                           Name: Nail Sharp</span>
<span class="go">Directory: /home/nail                 Shell: /usr/bin/sh</span>
<span class="go">Last login Wed Mar 31 18:32 2004 (PST)</span>
<span class="go">New mail received Thu Apr  1 10:50 2004 (PST)</span>
<span class="go">     Unread since Thu Apr  1 10:50 2004 (PST)</span>
<span class="go">No Plan.</span>
</pre></div>
<p>If the target computer does not have
the <tt class="docutils literal">fingerd</tt> <cite>daemon &lt;core-howto-glossary-daemon&gt;</cite>
running you'll get a "Connection Refused" error. Paranoid sysadmins
keep <tt class="docutils literal">fingerd</tt> off or limit the output to hinder crackers
and harassers. The above format is the standard <tt class="docutils literal">fingerd</tt>
default, but an alternate implementation can output anything it wants,
such as automated responsibility status for everyone in an
organization. You can also define pseudo "users", which are
essentially keywords.</p>
<p>This portion of the tutorial makes use of factories and protocols as
introduced in the <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/writing-servers.html">Writing a TCP Server howto</a> and
deferreds as introduced in <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/deferred-reference.html">Using Deferreds</a>
and <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/generating-deferreds.html">Generating Deferreds</a> . Services and
applications are discussed in <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/using-the-twisted-application-framework.html">Using the Twisted Application Framework</a> .</p>
<p>By the end of this section of the tutorial, our finger server will answer
TCP finger requests on port 1079, and will read data from the web.</p>
</div>
<div class="section" id="refuse-connections">
<h2><a class="toc-backref" href="#id2">Refuse Connections</a></h2>
<p><cite>finger01.py &lt;listings/finger/finger01.py&gt;</cite></p>
<p>This example only runs the reactor. It will consume almost no CPU
resources. As it is not listening on any port, it can't respond to network
requests — nothing at all will happen until we interrupt the program.  At
this point if you run <tt class="docutils literal">finger nail</tt> or <tt class="docutils literal">telnet localhost 1079</tt> , you'll get a "Connection refused" error since there's no daemon
running to respond.  Not very useful, perhaps — but this is the skeleton
inside which the Twisted program will grow.</p>
<p>As implied above, at various points in this tutorial you'll want to
observe the behavior of the server being developed.  Unless you have a
finger program which can use an alternate port, the easiest way to do this
is with a telnet client.  <tt class="docutils literal">telnet localhost 1079</tt> will connect to
the local host on port 1079, where a finger server will eventually be
listening.</p>
<div class="section" id="the-reactor">
<h3><a class="toc-backref" href="#id3">The Reactor</a></h3>
<p>You don't call Twisted, Twisted calls you. The <cite>reactor &lt;twisted.internet.reactor&gt;</cite> is Twisted's main event loop, similar to
the main loop in other toolkits available in Python (Qt, wx, and Gtk). There is
exactly one reactor in any running Twisted application. Once started it loops
over and over again, responding to network events and making scheduled calls to
code.</p>
<p>Note that there are actually several different reactors to choose
from; <tt class="docutils literal">from twisted.internet import reactor</tt> returns the
current reactor.  If you haven't chosen a reactor class yet, it
automatically chooses the default.  See
the <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/reactor-overview.html">Reactor Basics HOWTO</a> for
more information.</p>
</div>
</div>
<div class="section" id="do-nothing">
<h2><a class="toc-backref" href="#id4">Do Nothing</a></h2>
<p><cite>finger02.py &lt;listings/finger/finger02.py&gt;</cite></p>
<p>Here we use <tt class="docutils literal">endpoints.serverFromString</tt> to create a Twisted endpoint. An
endpoint is a Twisted concept that encapsulates one end of a connection. There
are different endpoints for clients and servers. One of the great advantages of
endpoints is that they can be described textually using a kind of
domain-specific language. For example, here, we ask Twisted to create a TCP
endpoint for a server using the string <tt class="docutils literal">"tcp:1079"</tt>. That, along with the
call to <tt class="docutils literal">serverFromString</tt>, tells Twisted to look for a TCP endpoint, and
pass it the port 1079. The endpoint returned from that function can then have
the <tt class="docutils literal">listen()</tt> method invoked on it, which causes Twisted to start listening
on port 1079. (The number 1079 is a reminder that eventually we want to run on
port 79, the standard port for finger servers.) For more detail on endpoints,
check out the <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/getting-connected-with-endpoints.html">Getting Connected With Endpoints</a>.</p>
<p>The factory given to the <tt class="docutils literal">listen()</tt> method, <tt class="docutils literal">FingerFactory</tt> , is used to
handle incoming requests on that port.  Specifically, for each request, the
reactor calls the factory's <tt class="docutils literal">buildProtocol</tt> method, which in this
case causes <tt class="docutils literal">FingerProtocol</tt> to be instantiated. Since the protocol
defined here does not actually respond to any events, connections to 1079 will
be accepted, but the input ignored.</p>
<p>A Factory is the proper place for data that you want to make available to
the protocol instances, since the protocol instances are garbage collected when
the connection is closed.</p>
</div>
<div class="section" id="drop-connections">
<h2><a class="toc-backref" href="#id5">Drop Connections</a></h2>
<p><cite>finger03.py &lt;listings/finger/finger03.py&gt;</cite></p>
<p>Here we add to the protocol the ability to respond to the event of beginning
a connection — by terminating it.  Perhaps not an interesting behavior,
but it is already close to behaving according to the letter of the standard
finger protocol. After all, there is no requirement to send any data to the
remote connection in the standard.  The only problem, as far as the standard is
concerned, is that we terminate the connection too soon. A client which is slow
enough will see his <tt class="docutils literal">send()</tt> of the username result in an error.</p>
</div>
<div class="section" id="read-username-drop-connections">
<h2><a class="toc-backref" href="#id6">Read Username, Drop Connections</a></h2>
<p><cite>finger04.py &lt;listings/finger/finger04.py&gt;</cite></p>
<p>Here we make <tt class="docutils literal">FingerProtocol</tt> inherit from <cite>LineReceiver &lt;twisted.protocols.basic.LineReceiver&gt;</cite> , so that we get data-based
events on a line-by-line basis. We respond to the event of receiving the line
with shutting down the connection.</p>
<p>If you use a telnet client to interact with this server, the result will
look something like this:</p>
<div class="highlight"><pre><span></span><span class="gp">$ </span>telnet localhost <span class="m">1079</span>
<span class="go">Trying 127.0.0.1...</span>
<span class="go">Connected to localhost.localdomain.</span>
<span class="go">alice</span>
<span class="go">Connection closed by foreign host.</span>
</pre></div>
<p>Congratulations, this is the first standard-compliant version of the code.
However, usually people actually expect some data about users to be
transmitted.</p>
</div>
<div class="section" id="read-username-output-error-drop-connections">
<h2><a class="toc-backref" href="#id7">Read Username, Output Error, Drop Connections</a></h2>
<p><cite>finger05.py &lt;listings/finger/finger05.py&gt;</cite></p>
<p>Finally, a useful version. Granted, the usefulness is somewhat limited by
the fact that this version only prints out a "No such user" message. It
could be used for devastating effect in honey-pots (decoy servers), of
course.</p>
</div>
<div class="section" id="output-from-empty-factory">
<h2><a class="toc-backref" href="#id8">Output From Empty Factory</a></h2>
<p><cite>finger06.py &lt;listings/finger/finger06.py&gt;</cite></p>
<p>The same behavior, but finally we see what usefulness the
factory has: as something that does not get constructed for
every connection, it can be in charge of the user database.
In particular, we won't have to change the protocol if
the user database back-end changes.</p>
</div>
<div class="section" id="output-from-non-empty-factory">
<h2><a class="toc-backref" href="#id9">Output from Non-empty Factory</a></h2>
<p><cite>finger07.py &lt;listings/finger/finger07.py&gt;</cite></p>
<p>Finally, a really useful finger database. While it does not
supply information about logged in users, it could be used to
distribute things like office locations and internal office
numbers. As hinted above, the factory is in charge of keeping
the user database: note that the protocol instance has not
changed. This is starting to look good: we really won't have
to keep tweaking our protocol.</p>
</div>
<div class="section" id="use-deferreds">
<h2><a class="toc-backref" href="#id10">Use Deferreds</a></h2>
<p><cite>finger08.py &lt;listings/finger/finger08.py&gt;</cite></p>
<p>But, here we tweak it just for the hell of it. Yes, while the
previous version worked, it did assume the result of getUser is
always immediately available. But what if instead of an in-memory
database, we would have to fetch the result from a remote Oracle server?  By
allowing getUser to return a Deferred, we make it easier for the data to be
retrieved asynchronously so that the CPU can be used for other tasks in the
meanwhile.</p>
<p>As described in the <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/deferred-reference.html">Deferred HOWTO</a> , Deferreds
allow a program to be driven by events.  For instance, if one task in a program
is waiting on data, rather than have the CPU (and the program!) idly waiting
for that data (a process normally called 'blocking'), the program can perform
other operations in the meantime, and waits for some signal that data is ready
to be processed before returning to that process.</p>
<p>In brief, the code in <tt class="docutils literal">FingerFactory</tt> above creates a
Deferred, to which we start to attach <em>callbacks</em> .  The
deferred action in <tt class="docutils literal">FingerFactory</tt> is actually a
fast-running expression consisting of one dictionary
method, <tt class="docutils literal">get</tt> . Since this action can execute without
delay, <tt class="docutils literal">FingerFactory.getUser</tt>
uses <tt class="docutils literal">defer.succeed</tt> to create a Deferred which already has
a result, meaning its return value will be passed immediately to the
first callback function, which turns out to
be <tt class="docutils literal">FingerProtocol.writeResponse</tt> .  We've also defined
an <em>errback</em> (appropriately
named <tt class="docutils literal">FingerProtocol.onError</tt> ) that will be called instead
of <tt class="docutils literal">writeResponse</tt> if something goes wrong.</p>
</div>
<div class="section" id="run-finger-locally">
<h2><a class="toc-backref" href="#id11">Run 'finger' Locally</a></h2>
<p><cite>finger09.py &lt;listings/finger/finger09.py&gt;</cite></p>
<p>This example also makes use of a
Deferred. <tt class="docutils literal">twisted.internet.utils.getProcessOutput</tt> is a
non-blocking version of Python's <tt class="docutils literal">commands.getoutput</tt> : it
runs a shell command (<tt class="docutils literal">finger</tt> , in this case) and captures
its standard output.  However, <tt class="docutils literal">getProcessOutput</tt> returns a
Deferred instead of the output itself.
Since <tt class="docutils literal">FingerProtocol.lineReceived</tt> is already expecting a
Deferred to be returned by <tt class="docutils literal">getUser</tt> , it doesn't need to be
changed, and it returns the standard output as the finger result.</p>
<p>Note that in this case the shell's built-in <tt class="docutils literal">finger</tt> command is
simply run with whatever arguments it is given. This is probably insecure, so
you probably don't want a real server to do this without a lot more validation
of the user input. This will do exactly what the standard version of the finger
server does.</p>
</div>
<div class="section" id="read-status-from-the-web">
<h2><a class="toc-backref" href="#id12">Read Status from the Web</a></h2>
<p>The web. That invention which has infiltrated homes around the
world finally gets through to our invention. In this case we use the
built-in Twisted web client
via <tt class="docutils literal">twisted.web.client.getPage</tt> , a non-blocking version of
Python's <cite>urllib2.urlopen(URL).read &lt;urllib2.urlopen&gt;</cite> .
Like <tt class="docutils literal">getProcessOutput</tt> it returns a Deferred which will be
called back with a string, and can thus be used as a drop-in
replacement.</p>
<p>Thus, we have examples of three different database back-ends, none of which
change the protocol class. In fact, we will not have to change the protocol
again until the end of this tutorial: we have achieved, here, one truly usable
class.</p>
<p><cite>finger10.py &lt;listings/finger/finger10.py&gt;</cite></p>
</div>
<div class="section" id="use-application">
<h2><a class="toc-backref" href="#id13">Use Application</a></h2>
<p>Up until now, we faked. We kept using port 1079, because really, who wants to
run a finger server with root privileges? Well, the common solution
is "privilege shedding" : after binding to the network, become a different,
less privileged user. We could have done it ourselves, but Twisted has a
built-in way to do it. We will create a snippet as above, but now we will define
an application object. That object will have <tt class="docutils literal">uid</tt>
and <tt class="docutils literal">gid</tt> attributes. When running it (later we will see how) it will
bind to ports, shed privileges and then run.</p>
<p>Read on to find out how to run this code using the twistd utility.</p>
</div>
<div class="section" id="twistd">
<h2><a class="toc-backref" href="#id14">twistd</a></h2>
<p>This is how to run "Twisted Applications" — files which define an
'application'. A daemon is expected to adhere to certain behavioral standards
so that standard tools can stop/start/query them.  If a Twisted application is
run via twistd, the TWISTed Daemonizer, all this behavioral stuff will be
handled for you. twistd does everything a daemon can be expected to —
shuts down stdin/stdout/stderr, disconnects from the terminal and can even
change runtime directory, or even the root filesystems. In short, it does
everything so the Twisted application developer can concentrate on writing his
networking code.</p>
<div class="highlight"><pre><span></span><span class="go">root% twistd -ny finger11.tac # just like before</span>
<span class="go">root% twistd -y finger11.tac # daemonize, keep pid in twistd.pid</span>
<span class="go">root% twistd -y finger11.tac --pidfile=finger.pid</span>
<span class="go">root% twistd -y finger11.tac --rundir=/</span>
<span class="go">root% twistd -y finger11.tac --chroot=/var</span>
<span class="go">root% twistd -y finger11.tac -l /var/log/finger.log</span>
<span class="go">root% twistd -y finger11.tac --syslog # just log to syslog</span>
<span class="go">root% twistd -y finger11.tac --syslog --prefix=twistedfinger # use given prefix</span>
</pre></div>
<p>There are several ways to tell twistd where your application is; here we
show how it is done using the <tt class="docutils literal">application</tt> global variable in a
Python source file (a <cite>Twisted Application
Configuration &lt;core-howto-glossary-tac&gt;</cite> file).</p>
<p><cite>finger11.tac &lt;listings/finger/finger11.tac&gt;</cite></p>
<p>Instead of using <tt class="docutils literal">endpoints.serverFromString</tt> as in the above
examples, here we are using its application-aware
counterpart, <tt class="docutils literal">strports.service</tt> .  Notice that when it is
instantiated, the application object itself does not reference either
the protocol or the factory.  Any services (such as the one we created with
<tt class="docutils literal">strports.service</tt>) which have the application as their parent will be
started when the application is started by twistd.  The application object is
more useful for returning an object that supports the
<cite>IService &lt;twisted.application.service.IService&gt;</cite> , <cite>IServiceCollection &lt;twisted.application.service.IServiceCollection&gt;</cite> , <cite>IProcess &lt;twisted.application.service.IProcess&gt;</cite> ,
and <cite>sob.IPersistable &lt;twisted.persisted.sob.IPersistable&gt;</cite>
interfaces with the given parameters; we'll be seeing these in the
next part of the tutorial. As the parent of the endpoint we opened, the
application lets us manage the endpoint.</p>
<p>With the daemon running on the standard finger port, you can test it with
the standard finger command: <tt class="docutils literal">finger moshez</tt> .</p>

</div>

        </div>
        </div>
        </div>
<div class="sphinxsidebar">
<div class="sphinxsidebarwrapper">
<div class="toc" id="">
<p class="topic-title">Table Of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a></li>
<li><a class="reference internal" href="#refuse-connections" id="id2">Refuse Connections</a><ul>
<li><a class="reference internal" href="#the-reactor" id="id3">The Reactor</a></li>
</ul>
</li>
<li><a class="reference internal" href="#do-nothing" id="id4">Do Nothing</a></li>
<li><a class="reference internal" href="#drop-connections" id="id5">Drop Connections</a></li>
<li><a class="reference internal" href="#read-username-drop-connections" id="id6">Read Username, Drop Connections</a></li>
<li><a class="reference internal" href="#read-username-output-error-drop-connections" id="id7">Read Username, Output Error, Drop Connections</a></li>
<li><a class="reference internal" href="#output-from-empty-factory" id="id8">Output From Empty Factory</a></li>
<li><a class="reference internal" href="#output-from-non-empty-factory" id="id9">Output from Non-empty Factory</a></li>
<li><a class="reference internal" href="#use-deferreds" id="id10">Use Deferreds</a></li>
<li><a class="reference internal" href="#run-finger-locally" id="id11">Run 'finger' Locally</a></li>
<li><a class="reference internal" href="#read-status-from-the-web" id="id12">Read Status from the Web</a></li>
<li><a class="reference internal" href="#use-application" id="id13">Use Application</a></li>
<li><a class="reference internal" href="#twistd" id="id14">twistd</a></li>
</ul>
</div>
</div>
</div>    </div>

    </section>

        <div id="footer"><hr>
                <div> </div>
                <p class="left2">
        Copyright 2021, Twisted Matrix Labs. Ver 21.2.0. Built on 2021-02-28.<br />
        Site design<br />
        By <a href="http://huw.ugbox.net/">huw.wilkins.</a>

                </p>
                <p class="right"></p>
        </div>


</body>
</html>