<!DOCTYPE html>
<html lang="en">
<head>
          <title>Test Pelican - Authentication with Perspective Broker</title>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />

        <meta name="Description" content="An event-driven networking engine written in Python and MIT licensed." />

        <link rel="stylesheet" type="text/css" href="https://judgegregg.github.io/pelitwi/theme/css/twistedtrac.css" />


</head>

<body>
        <div id="banner">
                <div id="top_grad"></div>
                <div id="tab">
                        <a href="https://twistedmatrix.com/trac/wiki">HOME</a>
                        <a href="https://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions">FAQ</a>
                        <a href="/">DOCS</a>
                        <a href="https://twistedmatrix.com/trac/wiki/Downloads">DOWNLOAD</a>
                </div>

                <div id="header">
                        <a id="logo" href="https://judgegregg.github.io/pelitwi/"><img src="https://judgegregg.github.io/pelitwi/theme/images/trac_banner.png" alt="Twisted" /></a>
                </div>
        </div>

<div id="mainnav" class="related">
	<ul>
		<li><a href="https://judgegregg.github.io/pelitwi">Twisted 21.2.0 documentation</a> Â»</li>
	</ul>
</div>
        <div id="ctxtnav" class="nav">
        </div>

    <section>

    <div class="document">
        <div class="documentwrapper">
        <div class="bodywrapper">
        <h1>Authentication with Perspective Broker</h1>
        
        <div class="entry-content">
        <div class="section" id="overview">
<h2><a class="toc-backref" href="#id10">Overview</a></h2>
<p>The examples shown in <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/using-perspective-broker.html">Using Perspective Broker</a> demonstrate how to do basic remote method calls, but provided no
facilities for authentication. In this context, authentication is about who
gets which remote references, and how to restrict access to the "right"
set of people or programs.</p>
<p>As soon as you have a program which offers services to multiple users,
where those users should not be allowed to interfere with each other, you
need to think about authentication. Many services use the idea of an "account" , and rely upon fact that each user has access to only one
account. Twisted uses a system called <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/cred-pluggable-authentication.html">cred</a> to
handle authentication issues, and Perspective Broker has code to make it
easy to implement the most common use cases.</p>
</div>
<div class="section" id="compartmentalizing-services">
<h2><a class="toc-backref" href="#id11">Compartmentalizing Services</a></h2>
<p>Imagine how you would write a chat server using PB. The first step might
be a <tt class="docutils literal">ChatServer</tt> object which had a bunch of
<tt class="docutils literal">pb.RemoteReference</tt> s that point at user clients. Pretend that
those clients offered a <tt class="docutils literal">remote_print</tt> method which lets the
server print a message on the user's console. In that case, the server might
look something like this:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ChatServer</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">Referenceable</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># indexed by name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># indexed by name</span>
    <span class="k">def</span> <span class="nf">remote_joinGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">groupname</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">groupname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">groupname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">groupname</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">remote_sendMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_username</span><span class="p">,</span> <span class="n">groupname</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">groupname</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">group</span><span class="p">:</span>
            <span class="c1"># send the message to all members of the group</span>
            <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                <span class="n">user</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">"print"</span><span class="p">,</span>
                                <span class="s2">"&lt;</span><span class="si">%s</span><span class="s2">&gt; says: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">from_username</span><span class="p">,</span>
                                                         <span class="n">message</span><span class="p">))</span>
</pre></div>
<p>For now, assume that all clients have somehow acquired a
<tt class="docutils literal">pb.RemoteReference</tt> to this <tt class="docutils literal">ChatServer</tt> object,
perhaps using <tt class="docutils literal">pb.Root</tt> and <tt class="docutils literal">getRootObject</tt> as
described in the <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/using-perspective-broker.html">previous chapter</a> . In this
scheme, when a user sends a message to the group, their client runs
something like the following:</p>
<div class="highlight"><pre><span></span><span class="n">remotegroup</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">"sendMessage"</span><span class="p">,</span> <span class="s2">"alice"</span><span class="p">,</span> <span class="s2">"Hi, my name is alice."</span><span class="p">)</span>
</pre></div>
<div class="section" id="incorrect-arguments">
<h3><a class="toc-backref" href="#id12">Incorrect Arguments</a></h3>
<p>You've probably seen the first problem: users can trivially spoof each
other. We depend upon the user to pass a correct value in their
"username" argument, and have no way to tell if they're lying or not.
There is nothing to prevent Alice from modifying her client to do:</p>
<div class="highlight"><pre><span></span><span class="n">remotegroup</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">"sendMessage"</span><span class="p">,</span> <span class="s2">"bob"</span><span class="p">,</span> <span class="s2">"i like pork"</span><span class="p">)</span>
</pre></div>
<p>much to the horror of Bob's vegetarian friends. <a class="footnote-reference" href="#id6" id="id1">[1]</a></p>
<p>(In general, learn to get suspicious if you see any argument of a
remotely-invokable method described as "must be X" )</p>
<p>The best way to fix this is to keep track of the user's name locally,
rather than asking them to send it to the server with each message. The best
place to keep state is in an object, so this suggests we need a per-user
object. Rather than choosing an obvious name <a class="footnote-reference" href="#id7" id="id2">[2]</a> , let's call this the
<tt class="docutils literal">User</tt> class.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">Referenceable</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">clientref</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote</span> <span class="o">=</span> <span class="n">clientref</span>
    <span class="k">def</span> <span class="nf">remote_joinGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groupname</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">joinGroup</span><span class="p">(</span><span class="n">groupname</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">remote_sendMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groupname</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">groupname</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">"print"</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ChatServer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># indexed by name</span>
    <span class="k">def</span> <span class="nf">joinGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groupname</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">groupname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">groupname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">groupname</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">sendMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_username</span><span class="p">,</span> <span class="n">groupname</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">groupname</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">group</span><span class="p">:</span>
            <span class="c1"># send the message to all members of the group</span>
            <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                <span class="n">user</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">"&lt;</span><span class="si">%s</span><span class="s2">&gt; says: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">from_username</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
</pre></div>
<p>Again, assume that each remote client gets access to a single
<tt class="docutils literal">User</tt> object, which is created with the proper username.</p>
<p>Note how the <tt class="docutils literal">ChatServer</tt> object has no remote access: it
isn't even <tt class="docutils literal">pb.Referenceable</tt> anymore. This means that all access
to it must be mediated through other objects, with code that is under your
control.</p>
<p>As long as Alice only has access to her own <tt class="docutils literal">User</tt> object, she
can no longer spoof Bob. The only way for her to invoke
<tt class="docutils literal">ChatServer.sendMessage</tt> is to call her <tt class="docutils literal">User</tt>
object's <tt class="docutils literal">remote_sendMessage</tt> method, and that method uses its
own state to provide the <tt class="docutils literal">from_username</tt> argument. It doesn't
give her any way to change that state.</p>
<p>This restriction is important. The <tt class="docutils literal">User</tt> object is able to
maintain its own integrity because there is a wall between the object and
the client: the client cannot inspect or modify internal state, like the
<tt class="docutils literal">.name</tt> attribute. The only way through this wall is via remote
method invocations, and the only control Alice has over those invocations is
when they get invoked and what arguments they are given.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">No object can maintain its integrity against local threats: by design,
Python offers no mechanism for class instances to hide their attributes, and
once an intruder has a copy of <tt class="docutils literal">self.__dict__</tt> , they can do
everything the original object was able to do.</p>
</div>
</div>
<div class="section" id="unforgeable-references">
<h3><a class="toc-backref" href="#id13">Unforgeable References</a></h3>
<p>Now suppose you wanted to implement group parameters, for example a mode
in which nobody was allowed to talk about mattresses because some users were
sensitive and calming them down after someone said "mattress" is a
hassle that's best avoided altogether. Again, per-group state implies a
per-group object. We'll go out on a limb and call this the
<tt class="docutils literal">Group</tt> object:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">Referenceable</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">clientref</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote</span> <span class="o">=</span> <span class="n">clientref</span>
    <span class="k">def</span> <span class="nf">remote_joinGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groupname</span><span class="p">,</span> <span class="n">allowMattress</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">joinGroup</span><span class="p">(</span><span class="n">groupname</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">allowMattress</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">"print"</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Group</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">Referenceable</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groupname</span><span class="p">,</span> <span class="n">allowMattress</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">groupname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allowMattress</span> <span class="o">=</span> <span class="n">allowMattress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">remote_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_user</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowMattress</span> <span class="ow">and</span> <span class="s2">"mattress"</span> <span class="ow">in</span> <span class="n">message</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Don't say that word"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">:</span>
            <span class="n">user</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">"&lt;</span><span class="si">%s</span><span class="s2">&gt; says: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">from_user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">addUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ChatServer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># indexed by name</span>
    <span class="k">def</span> <span class="nf">joinGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groupname</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">allowMattress</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">groupname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">groupname</span><span class="p">]</span> <span class="o">=</span> <span class="n">Group</span><span class="p">(</span><span class="n">groupname</span><span class="p">,</span> <span class="n">allowMattress</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">groupname</span><span class="p">]</span><span class="o">.</span><span class="n">addUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">groupname</span><span class="p">]</span>
</pre></div>
<p>This example takes advantage of the fact that
<tt class="docutils literal">pb.Referenceable</tt> objects sent over a wire can be returned to
you, and they will be turned into references to the same object that you
originally sent. The client cannot modify the object in any way: all they
can do is point at it and invoke its <tt class="docutils literal">remote_*</tt> methods. Thus,
you can be sure that the <tt class="docutils literal">.name</tt> attribute remains the same as
you left it. In this case, the client code would look something like
this:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ClientThing</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">Referenceable</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">remote_print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteUser</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">"joinGroup"</span><span class="p">,</span> <span class="s2">"#twisted"</span><span class="p">,</span>
                                       <span class="n">allowMattress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gotGroup</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">gotGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
        <span class="n">group</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">"send"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteUser</span><span class="p">,</span> <span class="s2">"hi everybody"</span><span class="p">)</span>
</pre></div>
<p>The <tt class="docutils literal">User</tt> object is sent from the server side, and is turned
into a <tt class="docutils literal">pb.RemoteReference</tt> when it arrives at the client. The
client sends it back to <tt class="docutils literal">Group.remote_send</tt> , and PB turns it back
into a reference to the original <tt class="docutils literal">User</tt> when it gets there.
<tt class="docutils literal">Group.remote_send</tt> can then use its <tt class="docutils literal">.name</tt> attribute
as the sender of the message.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Third party references (there aren't any)</p>
<p>This technique also relies upon the fact that the
<tt class="docutils literal">pb.Referenceable</tt> reference can <em>only</em> come from someone
who holds a corresponding <tt class="docutils literal">pb.RemoteReference</tt> . The design of the
serialization mechanism (implemented in <cite>twisted.spread.jelly</cite> : pb, jelly, spread.. get it?  Look for "banana" , too.  What other networking framework
can claim API names based on sandwich ingredients?) makes it impossible for
a client to obtain a reference that they weren't explicitly given.
References passed over the wire are given id numbers and recorded in a
per-connection dictionary. If you didn't give them the reference, the id
number won't be in the dict, and no amount of guessing by a malicious client
will give them anything else. The dict goes away when the connection is
dropped, further limiting the scope of those references.</p>
<p>Furthermore, it is not possible for Bob to send <em>his</em>
<tt class="docutils literal">User</tt> reference to Alice (perhaps over some other PB channel
just between the two of them). Outside the context of Bob's connection to
the server, that reference is just a meaningless number. To prevent
confusion, PB will tell you if you try to give it away: when you try to hand
a <tt class="docutils literal">pb.RemoteReference</tt> to a third party, you'll get an exception
(implemented with an assert in pb.py:364 RemoteReference.jellyFor).</p>
<p>This helps the security model somewhat: only the client you gave the
reference to can cause any damage with it. Of course, the client might be a
brainless zombie, simply doing anything some third party wants. When it's
not proxying <tt class="docutils literal">callRemote</tt> invocations, it's probably terrorizing
the living and searching out human brains for sustenance. In short, if you
don't trust them, don't give them that reference.</p>
<p>And remember that everything you've ever given them over that connection
can come back to you. If expect the client to invoke your method with some
object A that you sent to them earlier, and instead they send you object B
(that you also sent to them earlier), and you don't check it somehow, then
you've just opened up a security hole (we'll see an example of this
shortly). It may be better to keep such objects in a dictionary on the
server side, and have the client send you an index string instead. Doing it
that way makes it obvious that they can send you anything they want, and
improves the chances that you'll remember to implement the right checks.
(This is exactly what PB is doing underneath, with a per-connection
dictionary of <tt class="docutils literal">Referenceable</tt> objects, indexed by a number).</p>
<p class="last">And, of course, you have to make sure you don't accidentally hand out a
reference to the wrong object.</p>
</div>
<p>But again, note the vulnerability. If Alice holds a
<tt class="docutils literal">RemoteReference</tt> to <em>any</em> object on the server side that
has a <tt class="docutils literal">.name</tt> attribute, she can use that name as a spoofed"from" parameter. As a simple example, what if her client code looked
like:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ClientThing</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">Referenceable</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteUser</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">"joinGroup"</span><span class="p">,</span> <span class="s2">"#twisted"</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gotGroup</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">gotGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
        <span class="n">group</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">"send"</span><span class="p">,</span> <span class="n">from_user</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="s2">"hi everybody"</span><span class="p">)</span>
</pre></div>
<p>This would let her send a message that appeared to come from "#twisted" rather than "Alice" . If she joined a group that
happened to be named "bob" (perhaps it is the "How To Be Bob"
channel, populated by Alice and countless others, a place where they can
share stories about their best impersonating-Bob moments), then she would be
able to emit a message that looked like "&lt;bob&gt; says: hi there" ,
and she has accomplished her lifelong goal.</p>
</div>
<div class="section" id="argument-typechecking">
<h3><a class="toc-backref" href="#id14">Argument Typechecking</a></h3>
<p>There are two techniques to close this hole. The first is to have your
remotely-invokable methods do type-checking on their arguments: if
<tt class="docutils literal">Group.remote_send</tt> asserted <tt class="docutils literal">isinstance(from_user, User)</tt> then Alice couldn't use non-User objects to do her spoofing,
and hopefully the rest of the system is designed well enough to prevent her
from obtaining access to somebody else's User object.</p>
</div>
<div class="section" id="objects-as-capabilities">
<h3><a class="toc-backref" href="#id15">Objects as Capabilities</a></h3>
<p>The second technique is to avoid having the client send you the objects
altogether. If they don't send you anything, there is nothing to verify. In
this case, you would have to have a per-user-per-group object, in which the
<tt class="docutils literal">remote_send</tt> method would only take a single
<tt class="docutils literal">message</tt> argument. The <tt class="docutils literal">UserGroup</tt> object is created
with references to the only <tt class="docutils literal">User</tt> and <tt class="docutils literal">Group</tt> objects
that it will ever use, so no lookups are needed:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UserGroup</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">Referenceable</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">group</span>
    <span class="k">def</span> <span class="nf">remote_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Group</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groupname</span><span class="p">,</span> <span class="n">allowMattress</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">groupname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allowMattress</span> <span class="o">=</span> <span class="n">allowMattress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_user</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowMattress</span> <span class="ow">and</span> <span class="s2">"mattress"</span> <span class="ow">in</span> <span class="n">message</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Don't say that word"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">:</span>
            <span class="n">user</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">"&lt;</span><span class="si">%s</span><span class="s2">&gt; says: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">from_user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">addUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div>
<p>The only message-sending method Alice has left is
<tt class="docutils literal">UserGroup.remote_send</tt> , and it only accepts a message: there are
no remaining ways to influence the "from" name.</p>
<p>In this model, each remotely-accessible object represents a very small
set of capabilities. Security is achieved by only granting a minimal set of
abilities to each remote user.</p>
<p>PB provides a shortcut which makes this technique easier to use. The
<tt class="docutils literal">Viewable</tt> class will be discussed <cite>below &lt;core-howto-pb-cred-viewable&gt;</cite> .</p>
</div>
</div>
<div class="section" id="avatars-and-perspectives">
<h2><a class="toc-backref" href="#id16">Avatars and Perspectives</a></h2>
<p>In Twisted's <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/cred-pluggable-authentication.html">cred</a> system, an "Avatar" is
an object that lives on the "server" side (defined here as the side
farthest from the human who is trying to get something done) which lets the
remote user get something done. The avatar isn't really a particular class,
it's more like a description of a role that some object plays, as in "the Foo object here is acting as the user's avatar for this particular service" . Generally, the remote user has some way of getting their avatar
to run some code. The avatar object may enforce some security checks, and
provide additional data, then call other methods which get things done.</p>
<p>The two pieces in the cred puzzle (for any protocol, not just PB) are: "what serves as the Avatar?" , and "how does the user get access to it?" .</p>
<p>For PB, the first question is easy. The Avatar is a remotely-accessible
object which can run code: this is a perfect description of
<tt class="docutils literal">pb.Referenceable</tt> and its subclasses. We shall defer the second
question until the next section.</p>
<p>In the example above, you can think of the <tt class="docutils literal">ChatServer</tt> and
<tt class="docutils literal">Group</tt> objects as a service. The <tt class="docutils literal">User</tt> object is the
user's server-side representative: everything the user is capable of doing
is done by running one of its methods. Anything that the server wants to do
to the user (change their group membership, change their name, delete their
pet cat, whatever) is done by manipulating the <tt class="docutils literal">User</tt> object.</p>
<p>There are multiple User objects living in peace and harmony around the
ChatServer. Each has a different point of view on the services provided by
the ChatServer and the Groups: each may belong to different groups, some
might have more permissions than others (like the ability to create groups).
These different points of view are called "Perspectives" . This is the
origin of the term "Perspective" in "Perspective Broker" : PB
provides and controls (i.e. "brokers" ) access to Perspectives.</p>
<p>Once upon a time, these local-representative objects were actually called
<tt class="docutils literal">pb.Perspective</tt> . But this has changed with the advent of the
rewritten cred system, and now the more generic term for a local
representative object is an Avatar. But you will still see reference to
"Perspective" in the code, the docs, and the module names <a class="footnote-reference" href="#id8" id="id4">[3]</a> . Just remember
that perspectives and avatars are basically the same thing.</p>
<p>Despite all we've been <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/cred-pluggable-authentication.html">telling you</a> about how
Avatars are more of a concept than an actual class, the base class from
which you can create your server-side avatar-ish objects is, in fact, named
<tt class="docutils literal">pb.Avatar</tt> <a class="footnote-reference" href="#id9" id="id5">[4]</a> . These objects behave very much like
<tt class="docutils literal">pb.Referenceable</tt> . The only difference is that instead of
offering "remote_FOO" methods, they offer "perspective_FOO"
methods.</p>
<p>The other way in which <tt class="docutils literal">pb.Avatar</tt> differs from
<tt class="docutils literal">pb.Referenceable</tt> is that the avatar objects are designed to be
the first thing retrieved by a cred-using remote client. Just as
<tt class="docutils literal">PBClientFactory.getRootObject</tt> gives the client access to a
<tt class="docutils literal">pb.Root</tt> object (which can then provide access to all kinds of
other objects), <tt class="docutils literal">PBClientFactory.login</tt> gives client access to a
<tt class="docutils literal">pb.Avatar</tt> object (which can return other references).</p>
<p>So, the first half of using cred in your PB application is to create an
Avatar object which implements <tt class="docutils literal">perspective_</tt> methods and is
careful to do useful things for the remote user while remaining vigilant
against being tricked with unexpected argument values. It must also be
careful to never give access to objects that the user should not have access
to, whether by returning them directly, returning objects which contain
them, or returning objects which can be asked (remotely) to provide
them.</p>
<p>The second half is how the user gets a <tt class="docutils literal">pb.RemoteReference</tt> to
your Avatar. As explained <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/cred-pluggable-authentication.html">elsewhere</a> , Avatars are
obtained from a Realm. The Realm doesn't deal with authentication at all
(usernames, passwords, public keys, challenge-response systems, retinal
scanners, real-time DNA sequencers, etc). It simply takes an "avatarID"
(which is effectively a username) and returns an Avatar object. The Portal
and its Checkers deal with authenticating the user: by the time they are
done, the remote user has proved their right to access the avatarID that is
given to the Realm, so the Realm can return a remotely-controllable object
that has whatever powers you wish to grant to this particular user.</p>
<p>For PB, the realm is expected to return a <tt class="docutils literal">pb.Avatar</tt> (or
anything which implements <tt class="docutils literal">pb.IPerspective</tt> , really, but there's
no reason to not return a <tt class="docutils literal">pb.Avatar</tt> subclass). This object will
be given to the client just like a <tt class="docutils literal">pb.Root</tt> would be without
cred, and the user can get access to other objects through it (if you let
them).</p>
<p>The basic idea is that there is a separate IPerspective-implementing
object (i.e. the Avatar subclass) (i.e. the "perspective" ) for each
user, and <em>only</em> the authorized user gets a remote reference to that
object. You can store whatever permissions or capabilities the user
possesses in that object, and then use them when the user invokes a remote
method. You give the user access to the perspective object instead of the
objects that do the real work.</p>
</div>
<div class="section" id="perspective-examples">
<h2><a class="toc-backref" href="#id17">Perspective Examples</a></h2>
<p>Here is a brief example of using a pb.Avatar. Most of the support code
is magic for now: we'll explain it later.</p>
<div class="section" id="one-client">
<h3><a class="toc-backref" href="#id18">One Client</a></h3>
<p><cite>pb5server.py &lt;listings/pb/pb5server.py&gt;</cite></p>
<p><cite>pb5client.py &lt;listings/pb/pb5client.py&gt;</cite></p>
<p>Ok, so that wasn't really very exciting. It doesn't accomplish much more
than the first PB example, and used a lot more code to do it. Let's try it
again with two users this time.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>When the client runs <tt class="docutils literal">login</tt> to request the Perspective,
they can provide it with an optional <tt class="docutils literal">client</tt> argument (which
must be a <tt class="docutils literal">pb.Referenceable</tt> object). If they do, then a
reference to that object will be handed to the realm's
<tt class="docutils literal">requestAvatar</tt> in the <tt class="docutils literal">mind</tt> argument.</p>
<p class="last">The server-side Perspective can use it to invoke remote methods on
something in the client, so that the client doesn't always have to drive the
interaction. In a chat server, the client object would be the one to which"display text" messages were sent. In a board game server, this would
provide a way to tell the clients that someone has made a move, so they can
update their game boards.</p>
</div>
</div>
<div class="section" id="two-clients">
<h3><a class="toc-backref" href="#id19">Two Clients</a></h3>
<p><cite>pb6server.py &lt;listings/pb/pb6server.py&gt;</cite></p>
<p><cite>pb6client1.py &lt;listings/pb/pb6client1.py&gt;</cite></p>
<p><cite>pb6client2.py &lt;listings/pb/pb6client2.py&gt;</cite></p>
<p>While pb6server.py is running, try starting pb6client1, then pb6client2.
Compare the argument passed by the <tt class="docutils literal">.callRemote()</tt> in each
client. You can see how each client gets connected to a different
Perspective.</p>
</div>
<div class="section" id="how-that-example-worked">
<h3><a class="toc-backref" href="#id20">How that example worked</a></h3>
<p id="core-howto-pb-cred-smallexample">Let's walk through the previous example and see what was going on.</p>
<p>First, we created a subclass called <tt class="docutils literal">MyPerspective</tt> which is
our server-side Avatar. It implements a <tt class="docutils literal">perspective_foo</tt> method
that is exposed to the remote client.</p>
<p>Second, we created a realm (an object which implements
<tt class="docutils literal">IRealm</tt> , and therefore implements <tt class="docutils literal">requestAvatar</tt> ).
This realm manufactures <tt class="docutils literal">MyPerspective</tt> objects. It makes as many
as we want, and names each one with the avatarID (a username) that comes out
of the checkers. This MyRealm object returns two other objects as well,
which we will describe later.</p>
<p>Third, we created a portal to hold this realm. The portal's job is to
dispatch incoming clients to the credential checkers, and then to request
Avatars for any which survive the authentication process.</p>
<p>Fourth, we made a simple checker (an object which implements
<tt class="docutils literal">IChecker</tt> ) to hold valid user/password pairs. The checker
gets registered with the portal, so it knows who to ask when new
clients connect.  We use a checker named
<tt class="docutils literal">InMemoryUsernamePasswordDatabaseDontUse</tt> , which suggests
that 1: all the username/password pairs are kept in memory instead of
being saved to a database or something, and 2: you shouldn't use
it. The admonition against using it is because there are better
schemes: keeping everything in memory will not work when you have
thousands or millions of users to keep track of, the passwords will be
stored in the .tap file when the application shuts down (possibly a
security risk), and finally it is a nuisance to add or remove users
after the checker is constructed.</p>
<p>Fifth, we create a <tt class="docutils literal">pb.PBServerFactory</tt> to listen on a TCP
port. This factory knows how to connect the remote client to the Portal, so
incoming connections will be handed to the authentication process. Other
protocols (non-PB) would do something similar: the factory that creates
Protocol objects will give those objects access to the Portal so
authentication can take place.</p>
<p>On the client side, a <tt class="docutils literal">pb.PBClientFactory</tt> is created (as <a class="reference external" href="https://judgegregg.github.io/pelitwi/pages/using-perspective-broker.html">before</a> ) and attached to a TCP connection. When the
connection completes, the factory will be asked to produce a Protocol, and
it will create a PB object. Unlike the previous chapter, where we used
<tt class="docutils literal">.getRootObject</tt> , here we use <tt class="docutils literal">factory.login</tt> to
initiate the cred authentication process. We provide a
<tt class="docutils literal">credentials</tt> object, which is the client-side agent for doing
our half of the authentication process. This process may involve several
messages: challenges, responses, encrypted passwords, secure hashes, etc. We
give our credentials object everything it will need to respond correctly (in
this case, a username and password, but you could write a credential that
used public-key encryption or even fancier techniques).</p>
<p><tt class="docutils literal">login</tt> returns a Deferred which, when it fires, will return a
<tt class="docutils literal">pb.RemoteReference</tt> to the remote avatar. We can then do
<tt class="docutils literal">callRemote</tt> to invoke a <tt class="docutils literal">perspective_foo</tt> method on
that Avatar.</p>
</div>
<div class="section" id="anonymous-clients">
<h3><a class="toc-backref" href="#id21">Anonymous Clients</a></h3>
<p><cite>pbAnonServer.py &lt;listings/pb/pbAnonServer.py&gt;</cite></p>
<p><cite>pbAnonClient.py &lt;listings/pb/pbAnonClient.py&gt;</cite></p>
<p>pbAnonServer.py implements a server based on pb6server.py, extending it to
permit anonymous logins in addition to authenticated logins. An
<cite>AllowAnonymousAccess &lt;twisted.cred.checkers.AllowAnonymousAccess&gt;</cite>
checker and an <cite>InMemoryUsernamePasswordDatabaseDontUse &lt;twisted.cred.checkers.InMemoryUsernamePasswordDatabaseDontUse&gt;</cite>
checker are registered and the
client's choice of credentials object determines which is used to authenticate
the login.  In either case, the realm will be called on to create an avatar for
the login.  <tt class="docutils literal">AllowAnonymousAccess</tt> always produces an <tt class="docutils literal">avatarId</tt> of <tt class="docutils literal">twisted.cred.checkers.ANONYMOUS</tt> .</p>
<p>On the client side, the only change is the use of an instance of
<cite>Anonymous &lt;twisted.cred.credentials.Anonymous&gt;</cite> when calling
<cite>PBClientFactory.login &lt;twisted.spread.pb.PBClientFactory.login&gt;</cite> .</p>
</div>
</div>
<div class="section" id="using-avatars">
<h2><a class="toc-backref" href="#id22">Using Avatars</a></h2>
<div class="section" id="avatar-interfaces">
<h3><a class="toc-backref" href="#id23">Avatar Interfaces</a></h3>
<p>The first element of the 3-tuple returned by <tt class="docutils literal">requestAvatar</tt>
indicates which Interface this Avatar implements. For PB avatars, it will
always be <tt class="docutils literal">pb.IPerspective</tt> , because that's the only interface
these avatars implement.</p>
<p>This element is present because <tt class="docutils literal">requestAvatar</tt> is actually
presented with a list of possible Interfaces. The question being posed to
the Realm is: "do you have an avatar for (avatarID) that can implement one of the following set of Interfaces?" . Some portals and checkers might
give a list of Interfaces and the Realm could pick; the PB code only knows
how to do one, so we cannot take advantage of this feature.</p>
</div>
<div class="section" id="logging-out">
<h3><a class="toc-backref" href="#id24">Logging Out</a></h3>
<p>The third element of the 3-tuple is a zero-argument callable, which will
be invoked by the protocol when the connection has been lost. We can use
this to notify the Avatar when the client has lost its connection. This will
be described in more detail below.</p>
</div>
<div class="section" id="making-avatars">
<h3><a class="toc-backref" href="#id25">Making Avatars</a></h3>
<p>In the example above, we create Avatars upon request, during
<tt class="docutils literal">requestAvatar</tt> . Depending upon the service, these Avatars might
already exist before the connection is received, and might outlive the
connection. The Avatars might also accept multiple connections.</p>
<p>Another possibility is that the Avatars might exist ahead of time, but in
a different form (frozen in a pickle and/or saved in a database). In this
case, <tt class="docutils literal">requestAvatar</tt> may need to perform a database lookup and
then do something with the result before it can provide an avatar. In this
case, it would probably return a Deferred so it could provide the real
Avatar later, once the lookup had completed.</p>
<p>Here are some possible implementations of
<tt class="docutils literal">MyRealm.requestAvatar</tt> :</p>
<div class="highlight"><pre><span></span><span class="c1"># pre-existing, static avatars</span>
<span class="k">def</span> <span class="nf">requestAvatar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avatarID</span><span class="p">,</span> <span class="n">mind</span><span class="p">,</span> <span class="o">*</span><span class="n">interfaces</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">pb</span><span class="o">.</span><span class="n">IPerspective</span> <span class="ow">in</span> <span class="n">interfaces</span>
    <span class="n">avatar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avatars</span><span class="p">[</span><span class="n">avatarID</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pb</span><span class="o">.</span><span class="n">IPerspective</span><span class="p">,</span> <span class="n">avatar</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span><span class="kc">None</span>

<span class="c1"># database lookup and unpickling</span>
<span class="k">def</span> <span class="nf">requestAvatar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avatarID</span><span class="p">,</span> <span class="n">mind</span><span class="p">,</span> <span class="o">*</span><span class="n">interfaces</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">pb</span><span class="o">.</span><span class="n">IPerspective</span> <span class="ow">in</span> <span class="n">interfaces</span>
    <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">fetchAvatar</span><span class="p">(</span><span class="n">avatarID</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doUnpickle</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pb</span><span class="o">.</span><span class="n">IPerspective</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span><span class="kc">None</span>
<span class="k">def</span> <span class="nf">doUnpickle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pickled</span><span class="p">):</span>
    <span class="n">avatar</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pickled</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">avatar</span>

<span class="c1"># everybody shares the same Avatar</span>
<span class="k">def</span> <span class="nf">requestAvatar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avatarID</span><span class="p">,</span> <span class="n">mind</span><span class="p">,</span> <span class="o">*</span><span class="n">interfaces</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">pb</span><span class="o">.</span><span class="n">IPerspective</span> <span class="ow">in</span> <span class="n">interfaces</span>
    <span class="k">return</span> <span class="n">pb</span><span class="o">.</span><span class="n">IPerspective</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theOneAvatar</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span><span class="kc">None</span>

<span class="c1"># anonymous users share one Avatar, named users each get their own</span>
<span class="k">def</span> <span class="nf">requestAvatar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avatarID</span><span class="p">,</span> <span class="n">mind</span><span class="p">,</span> <span class="o">*</span><span class="n">interfaces</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">pb</span><span class="o">.</span><span class="n">IPerspective</span> <span class="ow">in</span> <span class="n">interfaces</span>
    <span class="k">if</span> <span class="n">avatarID</span> <span class="o">==</span> <span class="n">checkers</span><span class="o">.</span><span class="n">ANONYMOUS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pb</span><span class="o">.</span><span class="n">IPerspective</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">anonAvatar</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span><span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pb</span><span class="o">.</span><span class="n">IPerspective</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">avatars</span><span class="p">[</span><span class="n">avatarID</span><span class="p">],</span> <span class="k">lambda</span><span class="p">:</span><span class="kc">None</span>

<span class="c1"># anonymous users get independent (but temporary) Avatars</span>
<span class="c1"># named users get their own persistent one</span>
<span class="k">def</span> <span class="nf">requestAvatar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avatarID</span><span class="p">,</span> <span class="n">mind</span><span class="p">,</span> <span class="o">*</span><span class="n">interfaces</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">pb</span><span class="o">.</span><span class="n">IPerspective</span> <span class="ow">in</span> <span class="n">interfaces</span>
    <span class="k">if</span> <span class="n">avatarID</span> <span class="o">==</span> <span class="n">checkers</span><span class="o">.</span><span class="n">ANONYMOUS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pb</span><span class="o">.</span><span class="n">IPerspective</span><span class="p">,</span> <span class="n">MyAvatar</span><span class="p">(),</span> <span class="k">lambda</span><span class="p">:</span><span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pb</span><span class="o">.</span><span class="n">IPerspective</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">avatars</span><span class="p">[</span><span class="n">avatarID</span><span class="p">],</span> <span class="k">lambda</span><span class="p">:</span><span class="kc">None</span>
</pre></div>
<p>The last example, note that the new <tt class="docutils literal">MyAvatar</tt> instance is not
saved anywhere: it will vanish when the connection is dropped. By contrast,
the avatars that live in the <tt class="docutils literal">self.avatars</tt> dictionary will
probably get persisted into the .tap file along with the Realm, the Portal,
and anything else that is referenced by the top-level Application object.
This is an easy way to manage saved user profiles.</p>
</div>
<div class="section" id="connecting-and-disconnecting">
<h3><a class="toc-backref" href="#id26">Connecting and Disconnecting</a></h3>
<p>It may be useful for your Avatars to be told when remote clients gain
(and lose) access to them. For example, and Avatar might be updated by
something in the server, and if there are clients attached, it should update
them (through the "mind" argument which lets the Avatar do callRemote
on the client).</p>
<p>One common idiom which accomplishes this is to have the Realm tell the
avatar that a remote client has just attached. The Realm can also ask the
protocol to let it know when the connection goes away, so it can then inform
the Avatar that the client has detached. The third member of the
<tt class="docutils literal">requestAvatar</tt> return tuple is a callable which will be invoked
when the connection is lost.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyPerspective</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">Avatar</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clients</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">attached</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mind</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mind</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"attached to"</span><span class="p">,</span> <span class="n">mind</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">detached</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mind</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mind</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"detached from"</span><span class="p">,</span> <span class="n">mind</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span><span class="s2">"update"</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MyRealm</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">requestAvatar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avatarID</span><span class="p">,</span> <span class="n">mind</span><span class="p">,</span> <span class="o">*</span><span class="n">interfaces</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">pb</span><span class="o">.</span><span class="n">IPerspective</span> <span class="ow">in</span> <span class="n">interfaces</span>
        <span class="n">avatar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avatars</span><span class="p">[</span><span class="n">avatarID</span><span class="p">]</span>
        <span class="n">avatar</span><span class="o">.</span><span class="n">attached</span><span class="p">(</span><span class="n">mind</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pb</span><span class="o">.</span><span class="n">IPerspective</span><span class="p">,</span> <span class="n">avatar</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="o">=</span><span class="n">avatar</span><span class="p">:</span><span class="n">a</span><span class="o">.</span><span class="n">detached</span><span class="p">(</span><span class="n">mind</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="viewable">
<h3><a class="toc-backref" href="#id27">Viewable</a></h3>
<blockquote>
</blockquote>
<p id="core-howto-pb-cred-viewable">Once you have <tt class="docutils literal">IPerspective</tt> objects (i.e. the Avatar) to
represent users, the <cite>Viewable &lt;twisted.spread.pb.Viewable&gt;</cite> class can come into play. This
class behaves a lot like <tt class="docutils literal">Referenceable</tt> : it turns into a
<tt class="docutils literal">RemoteReference</tt> when sent over the wire, and certain methods
can be invoked by the holder of that reference. However, the methods that
can be called have names that start with <tt class="docutils literal">view_</tt> instead of  <tt class="docutils literal">remote_</tt> , and those methods are always called with an extra <tt class="docutils literal">perspective</tt> argument that points to the Avatar through which
the reference was sent:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">Viewable</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">view_doFoo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perspective</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
<p>This is useful if you want to let multiple clients share a reference to
the same object. The <tt class="docutils literal">view_</tt> methods can use the
"perspective" argument to figure out which client is calling them. This
gives them a way to do additional permission checks, do per-user accounting,
etc.</p>
<p>This is the shortcut which makes per-user-per-group capability objects
much easier to use. Instead of creating such per-(user,group) objects, you
just have per-group objects which inherit from <tt class="docutils literal">pb.Viewable</tt> , and
give the user references to them. The local <tt class="docutils literal">pb.Avatar</tt> object
will automatically show up as the "perspective" argument in the
<tt class="docutils literal">view_*</tt> method calls, give you a chance to involve the Avatar in
the process.</p>
</div>
<div class="section" id="chat-server-with-avatars">
<h3><a class="toc-backref" href="#id28">Chat Server with Avatars</a></h3>
<p>Combining all the above techniques, here is an example chat server which
uses a fixed set of identities (say, for the three members of your bridge
club, who hang out in "#NeedAFourth" hoping that someone will discover
your server, guess somebody's password, break in, join the group, and also
be available for a game next Saturday afternoon).</p>
<p><cite>chatserver.py &lt;listings/pb/chatserver.py&gt;</cite></p>
<p>Notice that the client uses <tt class="docutils literal">perspective_joinGroup</tt> to both
join a group and retrieve a <tt class="docutils literal">RemoteReference</tt> to the
<tt class="docutils literal">Group</tt> object. However, the reference they get is actually to a
special intermediate object called a <tt class="docutils literal">pb.ViewPoint</tt> . When they do
<tt class="docutils literal"><span class="pre">group.callRemote("send",</span> "message")</tt> , their avatar is inserted
into the argument list that <tt class="docutils literal">Group.view_send</tt> actually sees. This
lets the group get their username out of the Avatar without giving the
client an opportunity to spoof someone else.</p>
<p>The client side code that joins a group and sends a message would look
like this:</p>
<p><cite>chatclient.py &lt;listings/pb/chatclient.py&gt;</cite></p>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Apparently Alice is one of those weirdos who has nothing
better to do than to try and impersonate Bob. She will lie to her chat
client, send incorrect objects to remote methods, even rewrite her local
client code entirely to accomplish this juvenile prank. Given this
adversarial relationship, one must wonder why she and Bob seem to spend so
much time together: their adventures are clearly documented by the
cryptographic literature.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id7" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>The
obvious name is clearly
<tt class="docutils literal">ServerSidePerUserObjectWhichNobodyElseHasAccessTo</tt> , but because
Python makes everything else so easy to read, it only seems fair to make
your audience work for <em>something</em> .</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id8" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[3]</a></td><td>We could just go ahead and rename Perspective Broker to be
Avatar Broker, but 1) that would cause massive compatibility problems, and 2)
"AB"  doesn't fit into the whole sandwich-themed naming scheme nearly as
well as "PB"  does. If we changed it to AB, we'd probably have to change
Banana to be CD (CoderDecoder), and Jelly to be EF (EncapsulatorFragmentor).
twisted.spread would then have to be renamed twisted.alphabetsoup, and then
the whole food-pun thing would start all over again.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id9" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[4]</a></td><td>The avatar-ish class is named
<tt class="docutils literal">pb.Avatar</tt>  because <tt class="docutils literal">pb.Perspective</tt>  was already
taken, by the (now obsolete) oldcred perspective-ish class. It is a pity,
but it simply wasn't possible both replace <tt class="docutils literal">pb.Perspective</tt>
in-place <em>and</em>  maintain a reasonable level of
backwards-compatibility.</td></tr>
</tbody>
</table>

</div>
</div>

        </div>
        </div>
        </div>
<div class="sphinxsidebar">
<div class="sphinxsidebarwrapper">
<div class="toc" id="">
<p class="topic-title">Table Of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id10">Overview</a></li>
<li><a class="reference internal" href="#compartmentalizing-services" id="id11">Compartmentalizing Services</a><ul>
<li><a class="reference internal" href="#incorrect-arguments" id="id12">Incorrect Arguments</a></li>
<li><a class="reference internal" href="#unforgeable-references" id="id13">Unforgeable References</a></li>
<li><a class="reference internal" href="#argument-typechecking" id="id14">Argument Typechecking</a></li>
<li><a class="reference internal" href="#objects-as-capabilities" id="id15">Objects as Capabilities</a></li>
</ul>
</li>
<li><a class="reference internal" href="#avatars-and-perspectives" id="id16">Avatars and Perspectives</a></li>
<li><a class="reference internal" href="#perspective-examples" id="id17">Perspective Examples</a><ul>
<li><a class="reference internal" href="#one-client" id="id18">One Client</a></li>
<li><a class="reference internal" href="#two-clients" id="id19">Two Clients</a></li>
<li><a class="reference internal" href="#how-that-example-worked" id="id20">How that example worked</a></li>
<li><a class="reference internal" href="#anonymous-clients" id="id21">Anonymous Clients</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-avatars" id="id22">Using Avatars</a><ul>
<li><a class="reference internal" href="#avatar-interfaces" id="id23">Avatar Interfaces</a></li>
<li><a class="reference internal" href="#logging-out" id="id24">Logging Out</a></li>
<li><a class="reference internal" href="#making-avatars" id="id25">Making Avatars</a></li>
<li><a class="reference internal" href="#connecting-and-disconnecting" id="id26">Connecting and Disconnecting</a></li>
<li><a class="reference internal" href="#viewable" id="id27">Viewable</a></li>
<li><a class="reference internal" href="#chat-server-with-avatars" id="id28">Chat Server with Avatars</a></li>
</ul>
</li>
</ul>
</div>
</div>
</div>    </div>

    </section>

        <div id="footer"><hr>
                <div> </div>
                <p class="left2">
        Copyright 2021, Twisted Matrix Labs. Ver 21.2.0. Built on 2021-02-28.<br />
        Site design<br />
        By <a href="http://huw.ugbox.net/">huw.wilkins.</a>

                </p>
                <p class="right"></p>
        </div>


</body>
</html>